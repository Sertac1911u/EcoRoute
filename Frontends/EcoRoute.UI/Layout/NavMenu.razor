@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ILocalStorageService localStorage
@using System.Security.Claims
@using Blazored.LocalStorage
@using Microsoft.AspNetCore.Components.Authorization
@code {
    private List<string> userRoles = new();
    private bool isSuperAdmin = false;
    private bool isManager = false;
    private bool isDriver = false;
    private bool isExpanded = false;
    private bool isTransitioning = false;

    // Düzeltilmiş sınıf yönetimi
    private string GetMenuItemClass(bool expanded)
    {
        return expanded
            ? "menu-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-primary-100 dark:hover:bg-primary-900 group"
            : "menu-item flex items-center justify-center w-full px-2 py-3 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-primary-100 dark:hover:bg-primary-900 group";
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isSuperAdmin = user.IsInRole("SuperAdmin");
        isManager = user.IsInRole("Manager");
        isDriver = user.IsInRole("Driver");
        // Try to get the collapsed state from localStorage
        var savedState = await localStorage.GetItemAsync<bool?>("sidebarExpanded");
        isExpanded = savedState ?? false;
    }

    private async Task ToggleSidebar()
    {
        isTransitioning = true;
        isExpanded = !isExpanded;
        await localStorage.SetItemAsync("sidebarExpanded", isExpanded);

        // Reset transition state after animation completes
        // Use shorter delay for opening animation
        await Task.Delay(isExpanded ? 150 : 300);
        isTransitioning = false;
    }
}

<div class="hidden md:flex md:flex-shrink-0">
    <div class="flex flex-col bg-white dark:bg-gray-900 border-r border-gray-200 dark:border-gray-700 transition-all duration-300 ease-in-out @(isExpanded ? "w-64" : "w-16")">
        <div class="flex items-center justify-between h-16 border-b border-gray-200 dark:border-gray-700 px-4">
            <div class="flex items-center @(isExpanded ? "" : "justify-center w-full")">
                <i class="fas fa-recycle text-primary-500 text-2xl @(isExpanded ? "mr-2" : "") logo-icon"></i>
                @if (isExpanded)
                {
                    <h1 class="text-xl font-semibold ml-4 text-white bg-gradient-to-r from-primary-500 to-secondary-500 bg-clip-text text-transparent transition-opacity duration-200 @(isTransitioning ? "opacity-0" : "opacity-100") logo-text">EcoRoute</h1>
                }
            </div>
            @if (isExpanded)
            {
                <button @onclick="ToggleSidebar" class="text-gray-500 hover:text-primary-500 focus:outline-none transition-all duration-300">
                    <i class="fas fa-chevron-left"></i>
                </button>
            }
        </div>

        @if (!isExpanded)
        {
            <div class="flex justify-center w-full py-2">
                <button @onclick="ToggleSidebar" class="text-gray-500 hover:text-primary-500 focus:outline-none transition-all duration-300 rotate-180">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
        }

        <div class="flex flex-col flex-grow py-4 overflow-hidden @(isExpanded ? "px-3" : "px-2")">
            <nav class="flex-1 space-y-2">
                <div class="relative">
                    <NavLink href="/home" class="@GetMenuItemClass(isExpanded)" activeClass="bg-primary-100 dark:bg-primary-900">
                        <i class="fas fa-tachometer-alt @(isExpanded ? "mr-3" : "") text-primary-500"></i>
                        @if (isExpanded)
                        {
                            <span class="transition-opacity duration-200 delay-50 @(isTransitioning ? "opacity-0" : "opacity-100")">Ana Dashboard</span>
                        }
                    </NavLink>
                </div>

                @if (isSuperAdmin)
                {
                    <div class="relative">
                        <NavLink href="/users" class="@GetMenuItemClass(isExpanded)" activeClass="bg-primary-100 dark:bg-primary-900">
                            <i class="fas fa-users @(isExpanded ? "mr-3" : "") text-primary-500"></i>
                            @if (isExpanded)
                            {
                                <span class="transition-opacity duration-200 delay-75 @(isTransitioning ? "opacity-0" : "opacity-100")">Kullanıcı Yönetimi</span>
                            }
                        </NavLink>
                    </div>
                }

                @if (isSuperAdmin || isManager)
                {
                    <div class="relative">
                        <NavLink href="/bins" class="@GetMenuItemClass(isExpanded)" activeClass="bg-primary-100 dark:bg-primary-900">
                            <i class="fas fa-trash-alt @(isExpanded ? "mr-3" : "") text-primary-500"></i>
                            @if (isExpanded)
                            {
                                <span class="transition-opacity duration-200 delay-100 @(isTransitioning ? "opacity-0" : "opacity-100")">Atık Kutusu Yönetimi</span>
                            }
                        </NavLink>
                    </div>

                    <div class="relative">
                        <NavLink href="/routes" class="@GetMenuItemClass(isExpanded)" activeClass="bg-primary-100 dark:bg-primary-900">
                            <i class="fas fa-route @(isExpanded ? "mr-3" : "") text-primary-500"></i>
                            @if (isExpanded)
                            {
                                <span class="transition-opacity duration-200 delay-125 @(isTransitioning ? "opacity-0" : "opacity-100")">Rota Yönetimi</span>
                            }
                        </NavLink>
                    </div>

                    <div class="relative">
                        <NavLink href="/reports" class="@GetMenuItemClass(isExpanded)" activeClass="bg-primary-100 dark:bg-primary-900">
                            <i class="fas fa-chart-bar @(isExpanded ? "mr-3" : "") text-primary-500"></i>
                            @if (isExpanded)
                            {
                                <span class="transition-opacity duration-200 delay-150 @(isTransitioning ? "opacity-0" : "opacity-100")">Raporlama ve Analiz</span>
                            }
                        </NavLink>
                    </div>
                }

                @if (isDriver)
                {
                    <div class="relative">
                        <NavLink href="/driver-routes" class="@GetMenuItemClass(isExpanded)" activeClass="bg-primary-100 dark:bg-primary-900">
                            <i class="fas fa-map-marked-alt @(isExpanded ? "mr-3" : "") text-primary-500"></i>
                            @if (isExpanded)
                            {
                                <span class="transition-opacity duration-200 delay-175 @(isTransitioning ? "opacity-0" : "opacity-100")">Benim Rotalarım</span>
                            }
                        </NavLink>
                    </div>
                }

                <div class="relative">
                    <NavLink href="/notifications" class="@GetMenuItemClass(isExpanded)" activeClass="bg-primary-100 dark:bg-primary-900">
                        <div class="relative flex items-center">
                            <i class="fas fa-bell @(isExpanded ? "mr-3" : "") text-primary-500"></i>
                            <span class="absolute -top-2 -right-1 bg-red-500 text-white text-xs font-medium px-1.5 py-0.5 rounded-full">3</span>
                        </div>
                        @if (isExpanded)
                        {
                            <span class="transition-opacity duration-200 delay-200 @(isTransitioning ? "opacity-0" : "opacity-100")">Bildirimler</span>
                        }
                    </NavLink>
                </div>

                @if (isSuperAdmin)
                {
                    <div class="relative">
                        <NavLink href="/settings" class="@GetMenuItemClass(isExpanded)" activeClass="bg-primary-100 dark:bg-primary-900">
                            <i class="fas fa-cog @(isExpanded ? "mr-3" : "") text-primary-500"></i>
                            @if (isExpanded)
                            {
                                <span class="transition-opacity duration-200 delay-225 @(isTransitioning ? "opacity-0" : "opacity-100")">Sistem Ayarları</span>
                            }
                        </NavLink>
                    </div>
                }

                <div class="relative">
                    <NavLink href="/supports" class="@GetMenuItemClass(isExpanded)" activeClass="bg-primary-100 dark:bg-primary-900">
                        <i class="fas fa-headset @(isExpanded ? "mr-3" : "") text-primary-500"></i>
                        @if (isExpanded)
                        {
                            <span class="transition-opacity duration-200 delay-250 @(isTransitioning ? "opacity-0" : "opacity-100")">Destek</span>
                        }
                    </NavLink>
                </div>
            </nav>
        </div>
    </div>
</div>

<style>
    /* Animation for logo icon */
    .logo-icon {
        animation: pulse 2s infinite;
        transform-origin: center;
    }

    @@keyframes pulse {
        0%

    {
        transform: scale(1);
    }

    50% {
        transform: scale(1.1);
        color: #10B981;
    }

    100% {
        transform: scale(1);
    }

    }

    /* Animation for logo text */
    .logo-text {
        background: linear-gradient(90deg, #10B981, #3B82F6, #10B981);
        background-size: 200% auto;
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
        animation: gradient 3s linear infinite;
        font-weight: bold;
        letter-spacing: 0.5px;
    }

    @@keyframes gradient {
        0%

    {
        background-position: 0% center;
    }

    100% {
        background-position: 200% center;
    }

    }

    /* Ensure smooth transition for delayed text appearance */
    span.delay-50 {
        transition-delay: 50ms;
    }

    span.delay-75 {
        transition-delay: 75ms;
    }

    span.delay-100 {
        transition-delay: 100ms;
    }

    span.delay-125 {
        transition-delay: 125ms;
    }

    span.delay-150 {
        transition-delay: 150ms;
    }

    span.delay-175 {
        transition-delay: 175ms;
    }

    span.delay-200 {
        transition-delay: 200ms;
    }

    span.delay-225 {
        transition-delay: 225ms;
    }

    span.delay-250 {
        transition-delay: 250ms;
    }
</style>