@page "/routes"
@using EcoRoute.DtoLayer.IdentityDtos
@using EcoRoute.DtoLayer.RouteOptimizationDtos
@using EcoRoute.DtoLayer.WasteBinDtos
@using EcoRoute.UI.Services
@using EcoRoute.UI.Services.RouteOptimizationServices
@using EcoRoute.UI.Services.WasteBinServices
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Text.Json
@inject IRouteService RouteService
@inject WasteBinService WasteBinService
@inject UserService UserService
@inject VehicleService VehicleService
@inject AuthenticationStateProvider AuthProvider
@inject IToastService toastService
@inject IJSRuntime JS
@implements IAsyncDisposable

@attribute [Authorize(Roles = "SuperAdmin, Manager")]

<!-- Main Container -->
<div class="bg-white dark:bg-gray-900 shadow-md rounded-lg overflow-hidden mb-6">
    @if (routes == null || filteredRoutes == null)
    {
        <div class="flex justify-center items-center p-8">
            <div class="text-center">
                <i class="fas fa-circle-notch fa-spin text-4xl text-primary-500 mb-4"></i>
                <p class="text-gray-600 dark:text-gray-300">Veriler yükleniyor...</p>
            </div>
        </div>
    }
    else
    {
        <!-- Header Section -->
        <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-2xl font-semibold text-gray-800 dark:text-white">Rota Yönetimi</h2>
            <div class="flex space-x-2">
                <button class="flex items-center bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition duration-300" @onclick="RefreshData">
                    <i class="fas fa-sync-alt mr-2"></i> Yenile
                </button>
                <button class="flex items-center bg-primary-500 text-white px-4 py-2 rounded-md hover:bg-primary-600 transition duration-300" @onclick="OpenCreateModal">
                    <i class="fas fa-plus mr-2"></i> Yeni Rota Ekle
                </button>
            </div>
        </div>

        <!-- Map Section -->
        <div class="p-4 bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
            <div class="rounded-lg overflow-hidden shadow-md">
                <div id="admin-observer-map" class="w-full h-96 relative">
                    <!-- Loading Indicator -->
                    <div id="map-loading-indicator" class="absolute inset-0 flex items-center justify-center bg-gray-100 dark:bg-gray-800 bg-opacity-75 dark:bg-opacity-75 z-10">
                        <div class="text-center">
                            <i class="fas fa-circle-notch fa-spin text-4xl text-primary-500 mb-2"></i>
                            <p class="text-gray-600 dark:text-gray-300">Harita yükleniyor...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="p-4 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 filter-section">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sürücü</label>
                    <select @bind="driverFilter" @bind:event="oninput" @onchange="ApplyFiltersWithDebounce"
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                        <option value="">Tümü</option>
                        @foreach (var driver in drivers)
                        {
                            <option value="@driver.Id">@driver.Name @driver.Surname</option>
                        }
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Durum</label>
                    <select @bind="statusFilter" @bind:event="oninput" @onchange="ApplyFiltersWithDebounce"
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                        <option value="">Tümü</option>
                        <option value="@RouteStatus.Scheduled">Planlanmış</option>
                        <option value="@RouteStatus.Active">Aktif</option>
                        <option value="@RouteStatus.Completed">Tamamlanmış</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Arama</label>
                    <div class="relative">
                        <input type="text" placeholder="Ara..." @bind="searchText" @bind:event="oninput" @onkeyup="ApplyFiltersWithDebounce"
                               class="w-full px-3 py-2 pl-10 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" />
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tarih Aralığı</label>
                    <div class="flex space-x-2">
                        <input type="date" @bind="startDateFilter" @bind:event="oninput" @onchange="ApplyFiltersWithDebounce"
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" />
                        <input type="date" @bind="endDateFilter" @bind:event="oninput" @onchange="ApplyFiltersWithDebounce"
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" />
                    </div>
                </div>

                <div class="md:col-span-4 flex justify-end mt-4">
                    <button class="flex items-center justify-center bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-300"
                            @onclick="ClearFilters">
                        <i class="fas fa-filter-circle-xmark mr-2"></i> Filtreleri Temizle
                    </button>
                </div>
            </div>
        </div>
        <!-- Routes Table Section -->
        <div class="p-6">
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white dark:bg-gray-800 rounded-lg overflow-hidden">
                    <thead class="bg-gray-100 dark:bg-gray-700">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600" @onclick='() => SortTable("StartTime")'>
                                <div class="flex items-center">
                                    Başlangıç
                                    @if (sortField == "StartTime")
                                    {
                                        <i class="fas @(sortAscending ? "fa-sort-up" : "fa-sort-down") ml-1"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-sort ml-1 text-gray-400"></i>
                                    }
                                </div>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600" @onclick='() => SortTable("Driver")'>
                                <div class="flex items-center">
                                    Sürücü
                                    @if (sortField == "Driver")
                                    {
                                        <i class="fas @(sortAscending ? "fa-sort-up" : "fa-sort-down") ml-1"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-sort ml-1 text-gray-400"></i>
                                    }
                                </div>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600" @onclick='() => SortTable("Vehicle")'>
                                <div class="flex items-center">
                                    Araç
                                    @if (sortField == "Vehicle")
                                    {
                                        <i class="fas @(sortAscending ? "fa-sort-up" : "fa-sort-down") ml-1"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-sort ml-1 text-gray-400"></i>
                                    }
                                </div>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600" @onclick='() => SortTable("Status")'>
                                <div class="flex items-center">
                                    Durum
                                    @if (sortField == "Status")
                                    {
                                        <i class="fas @(sortAscending ? "fa-sort-up" : "fa-sort-down") ml-1"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-sort ml-1 text-gray-400"></i>
                                    }
                                </div>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600" @onclick='() => SortTable("Distance")'>
                                <div class="flex items-center">
                                    Mesafe (km)
                                    @if (sortField == "Distance")
                                    {
                                        <i class="fas @(sortAscending ? "fa-sort-up" : "fa-sort-down") ml-1"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-sort ml-1 text-gray-400"></i>
                                    }
                                </div>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600" @onclick='() => SortTable("Duration")'>
                                <div class="flex items-center">
                                    Süre (dk)
                                    @if (sortField == "Duration")
                                    {
                                        <i class="fas @(sortAscending ? "fa-sort-up" : "fa-sort-down") ml-1"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-sort ml-1 text-gray-400"></i>
                                    }
                                </div>
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">İşlemler</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                        @if (filteredRoutes == null)
                        {
                            <tr>
                                <td colspan="7" class="px-4 py-4 text-center text-gray-500 dark:text-gray-400">
                                    <div class="flex justify-center items-center">
                                        <i class="fas fa-circle-notch fa-spin mr-2"></i> Yükleniyor...
                                    </div>
                                </td>
                            </tr>
                        }
                        else if (!filteredRoutes.Any())
                        {
                            <tr>
                                <td colspan="7" class="px-4 py-4 text-center text-gray-500 dark:text-gray-400">
                                    <div class="flex flex-col justify-center items-center p-6">
                                        <i class="fas fa-route text-4xl mb-2 text-gray-400"></i>
                                        <p>Görüntülenecek rota bulunamadı.</p>
                                        <p class="text-sm text-gray-500 dark:text-gray-500 mt-2">Yeni bir rota ekleyin veya farklı filtreler deneyin.</p>
                                    </div>
                                </td>
                            </tr>
                        }
                        else
                        {
                            @for (int i = 0; i < displayedRoutes.Count; i++)
                            {
                                var route = displayedRoutes[i];
                                var rowIndex = ((currentPage - 1) * pageSize) + i + 1;
                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer @(expandedRouteId == route.Id ? "bg-gray-50 dark:bg-gray-700" : "")"
                                    @onclick="@(() => ToggleExpand(route.Id))">
                                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">@FormatDateTime(route.StartTime)</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">
                                        <div class="flex items-center">
                                            <i class="fas fa-user-hard-hat text-lg mr-3 text-primary-500"></i>
                                            <span>@GetDriverName(route.DriverId)</span>
                                        </div>
                                    </td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">
                                        <div class="flex items-center">
                                            <i class="fas fa-truck text-lg mr-3 text-blue-500"></i>
                                            <span>@GetVehiclePlate(route.VehicleId)</span>
                                        </div>
                                    </td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm">
                                        <span class="@GetStatusBadgeClass(route.Status) px-2 py-1 rounded-full text-xs">
                                            @GetStatusText(route.Status)
                                        </span>
                                    </td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">@route.TotalDistanceKm.ToString("F1")</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">@route.EstimatedDurationMin</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm">
                                        <div class="flex space-x-3" @onclick:stopPropagation>
                                            @if (route.Status != RouteStatus.Completed)
                                            {
                                                <button class="text-green-500 hover:text-green-700 text-lg tooltip-container" @onclick="() => CompleteRoute(route.Id)">
                                                    <i class="fas fa-check-circle"></i>
                                                    <span class="tooltip">Tamamla</span>
                                                </button>
                                            }
                                            <button class="text-blue-500 hover:text-blue-700 text-lg tooltip-container" @onclick="() => ShowDetails(route)">
                                                <i class="fas fa-info-circle"></i>
                                                <span class="tooltip">Detay</span>
                                            </button>
                                            <button class="text-primary-500 hover:text-primary-700 text-lg tooltip-container" @onclick="() => FocusRouteOnMap(route.Id)">
                                                <i class="fas fa-map-marker"></i>
                                                <span class="tooltip">Haritada Göster</span>
                                            </button>
                                        </div>
                                    </td>
                                </tr>

                                @if (expandedRouteId == route.Id)
                                {
                                    <tr class="@(route.Status == RouteStatus.Completed ? "bg-gray-50 dark:bg-gray-800/50" : "bg-gray-50 dark:bg-gray-800") border-t animate-expandRow">
                                        <td colspan="7" class="px-6 py-6">
                                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                                <!-- Genel Bilgiler -->
                                                <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow-md transform transition-all duration-300 hover:scale-105">
                                                    <div class="flex justify-between items-center mb-4">
                                                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center">
                                                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                                                            Genel Bilgiler
                                                        </h3>
                                                        <span class="@GetStatusBadgeClass(route.Status) px-2 py-1 rounded-full text-xs">
                                                            @GetStatusText(route.Status)
                                                        </span>
                                                    </div>

                                                    <div class="space-y-3">
                                                        <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-2">
                                                            <span class="text-sm text-gray-500 dark:text-gray-400">Başlangıç Tarihi:</span>
                                                            <span class="text-sm font-medium text-gray-800 dark:text-gray-200">@route.StartTime.ToString("dd.MM.yyyy HH:mm")</span>
                                                        </div>
                                                        <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-2">
                                                            <span class="text-sm text-gray-500 dark:text-gray-400">Toplam Mesafe:</span>
                                                            <span class="text-sm font-medium text-gray-800 dark:text-gray-200">@route.TotalDistanceKm.ToString("F1") km</span>
                                                        </div>
                                                        <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-2">
                                                            <span class="text-sm text-gray-500 dark:text-gray-400">Tahmini Süre:</span>
                                                            <span class="text-sm font-medium text-gray-800 dark:text-gray-200">@route.EstimatedDurationMin dk</span>
                                                        </div>
                                                        <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-2">
                                                            <span class="text-sm text-gray-500 dark:text-gray-400">Tahmini Yakıt:</span>
                                                            <span class="text-sm font-medium text-gray-800 dark:text-gray-200">@route.EstimatedFuelL.ToString("F2") L</span>
                                                        </div>
                                                        <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-2">
                                                            <span class="text-sm text-gray-500 dark:text-gray-400">Tahmini CO2:</span>
                                                            <span class="text-sm font-medium text-gray-800 dark:text-gray-200">@route.EstimatedCO2Kg.ToString("F2") kg</span>
                                                        </div>
                                                        <div class="flex justify-between items-center">
                                                            <span class="text-sm text-gray-500 dark:text-gray-400">Atık Tipi:</span>
                                                            <span class="text-sm font-medium text-gray-800 dark:text-gray-200">
                                                                @route.WasteType
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Rota Özeti -->
                                                <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow-md transform transition-all duration-300 hover:scale-105">
                                                    <div class="flex justify-between items-center mb-4">
                                                        <h3 class="!text-lg font-semibold text-gray-800 dark:text-white flex items-center">
                                                            <i class="fas fa-route mr-2 text-amber-500"></i>
                                                            Rota Özeti
                                                        </h3>
                                                    </div>

                                                    <div class="space-y-3">
                                                        <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-2">
                                                            <span class="text-sm text-gray-500 dark:text-gray-400">Toplam Adım Sayısı:</span>
                                                            <span class="text-sm font-medium text-gray-800 dark:text-gray-200">@route.Steps.Count() adet</span>
                                                        </div>
                                                        <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-2">
                                                            <span class="text-sm text-gray-500 dark:text-gray-400">Tamamlanan Adımlar:</span>
                                                            <span class="text-sm font-medium text-gray-800 dark:text-gray-200">@route.Steps.Count(s => s.IsCompleted) adet</span>
                                                        </div>
                                                        <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-2">
                                                            <span class="text-sm text-gray-500 dark:text-gray-400">Kalan Adımlar:</span>
                                                            <span class="text-sm font-medium text-gray-800 dark:text-gray-200">@route.Steps.Count(s => !s.IsCompleted) adet</span>
                                                        </div>
                                                        <div class="flex justify-between items-center">
                                                            <span class="text-sm text-gray-500 dark:text-gray-400">Optimizasyon Tipi:</span>
                                                            <span class="text-sm font-medium text-gray-800 dark:text-gray-200">
                                                                @GetOptimizationTypeText(route.OptimizationType)
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- İlerleme Durumu -->
                                                <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow-md transform transition-all duration-300 hover:scale-105">
                                                    <div class="flex justify-between items-center mb-4">
                                                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center">
                                                            <i class="fas fa-chart-line mr-2 text-green-500"></i>
                                                            İlerleme Durumu
                                                        </h3>
                                                        <button class="text-primary-500 hover:text-primary-700 px-2 py-1 rounded text-xs border border-primary-500"
                                                                @onclick:stopPropagation="true"
                                                                @onclick="() => ShowDetails(route)">
                                                            <i class="fas fa-play mr-1"></i> Simüle Et
                                                        </button>
                                                    </div>

                                                    <div class="space-y-4">
                                                        <!-- Progress Circle -->
                                                        <div class="flex justify-center">
                                                            @{
                                                                double progressPercentage = route.Steps.Any()
                                                                ? (double)route.Steps.Count(s => s.IsCompleted) / route.Steps.Count * 100
                                                                : 0;
                                                            }
                                                            <div class="relative w-24 h-24">
                                                                <svg class="w-full h-full" viewBox="0 0 36 36">
                                                                    <path class="stroke-current text-gray-200 dark:text-gray-700" fill="none" stroke-width="3.8" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                                                    <path class="@GetProgressColor(progressPercentage) stroke-current" fill="none" stroke-width="3.8" stroke-linecap="round"
                                                                          stroke-dasharray="@(progressPercentage), 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                                                    <text x="18" y="20.5" class="fill-current font-bold text-gray-700 dark:text-gray-200" text-anchor="middle" font-size="7">@progressPercentage.ToString("F0")%</text>
                                                                </svg>
                                                            </div>
                                                        </div>

                                                        <!-- Progress Bar -->
                                                        <div>
                                                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-2">
                                                                <div class="@GetProgressColor(progressPercentage) h-2.5 rounded-full" style="width: @progressPercentage%"></div>
                                                            </div>
                                                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                                                                <span>0%</span>
                                                                <span>50%</span>
                                                                <span>100%</span>
                                                            </div>
                                                        </div>

                                                        @if (route.Status != RouteStatus.Completed)
                                                        {
                                                            <button class="w-full mt-2 py-1.5 bg-green-500 hover:bg-green-600 text-white rounded-md transition-colors flex items-center justify-center"
                                                                    @onclick:stopPropagation="true"
                                                                    @onclick="() => CompleteRoute(route.Id)">
                                                                <i class="fas fa-check-circle mr-2"></i> Rotayı Tamamla
                                                            </button>
                                                        }
                                                        else
                                                        {
                                                            <div class="w-full mt-2 py-1.5 bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 rounded-md flex items-center justify-center">
                                                                <i class="fas fa-check-double mr-2"></i> Rota Tamamlandı
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Adımlar Listesi -->
                                            <div class="mt-6">
                                                <h4 class="font-semibold text-gray-800 dark:text-white mb-3 flex items-center">
                                                    <i class="fas fa-list-check mr-2 text-primary-500"></i> Rota Adımları
                                                </h4>
                                                <div class="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                                                    <table class="min-w-full">
                                                        <thead class="bg-gray-50 dark:bg-gray-700">
                                                            <tr>
                                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">No</th>
                                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Adres</th>
                                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Konum</th>
                                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Durum</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                                            @foreach (var step in route.Steps.OrderBy(s => s.Order))
                                                            {
                                                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                                                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">@step.Order</td>
                                                                    <td class="px-4 py-2 text-sm text-gray-700 dark:text-gray-300">@step.Address</td>
                                                                    <td class="px-4 py-2 text-sm text-gray-500 dark:text-gray-400">(@step.Latitude.ToString("F4"), @step.Longitude.ToString("F4"))</td>
                                                                    <td class="px-4 py-2 whitespace-nowrap">
                                                                        <span class="@(step.IsCompleted ? "bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300" : "bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-300") px-2 py-0.5 rounded-full text-xs">
                                                                            @(step.IsCompleted ? "Tamamlandı" : "Beklemede")
                                                                        </span>
                                                                    </td>
                                                                </tr>
                                                            }
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                        }
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            @if (filteredRoutes != null && totalPages > 1)
            {
                <div class="flex justify-center mt-4">
                    <div class="flex space-x-1">
                        <button @onclick="() => ChangePage(1)"
                                disabled="@(currentPage == 1)"
                                class="@(currentPage == 1 ? "bg-gray-100 text-gray-400 cursor-not-allowed" : "bg-white text-primary-500 hover:bg-primary-50") px-3 py-1 rounded-md border border-gray-200">
                            <i class="fas fa-angle-double-left"></i>
                        </button>
                        <button @onclick="() => ChangePage(currentPage - 1)"
                                disabled="@(currentPage == 1)"
                                class="@(currentPage == 1 ? "bg-gray-100 text-gray-400 cursor-not-allowed" : "bg-white text-primary-500 hover:bg-primary-50") px-3 py-1 rounded-md border border-gray-200">
                            <i class="fas fa-angle-left"></i>
                        </button>

                        @for (int i = startPage; i <= endPage; i++)
                        {
                            var pageNumber = i;
                            <button @onclick="() => ChangePage(pageNumber)"
                                    class="@(currentPage == pageNumber ? "bg-primary-500 text-white" : "bg-white text-primary-500 hover:bg-primary-50") px-3 py-1 rounded-md border border-gray-200">
                                @pageNumber
                            </button>
                        }

                        <button @onclick="() => ChangePage(currentPage + 1)"
                                disabled="@(currentPage == totalPages)"
                                class="@(currentPage == totalPages ? "bg-gray-100 text-gray-400 cursor-not-allowed" : "bg-white text-primary-500 hover:bg-primary-50") px-3 py-1 rounded-md border border-gray-200">
                            <i class="fas fa-angle-right"></i>
                        </button>
                        <button @onclick="() => ChangePage(totalPages)"
                                disabled="@(currentPage == totalPages)"
                                class="@(currentPage == totalPages ? "bg-gray-100 text-gray-400 cursor-not-allowed" : "bg-white text-primary-500 hover:bg-primary-50") px-3 py-1 rounded-md border border-gray-200">
                            <i class="fas fa-angle-double-right"></i>
                        </button>
                    </div>
                </div>
            }

            <div class="text-xs text-gray-500 dark:text-gray-400 mt-4 text-center">
                Toplam @(filteredRoutes?.Count ?? 0) rota
            </div>
        </div>
    }
</div>

<!-- Route Details Modal -->
@if (isModalOpen && selectedRoute != null)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto animate-modal-show">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700 sticky top-0 bg-white dark:bg-gray-800 z-10">
                <h2 class="text-xl font-semibold text-gray-800 dark:text-white flex items-center">
                    <i class="fas fa-route mr-3 text-primary-500"></i>
                    @(GetDriverName(selectedRoute.DriverId) + " - " + FormatDateTime(selectedRoute.StartTime))
                </h2>
                <button class="text-gray-500 hover:text-red-600" @onclick="CloseModal">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="p-6">
                <!-- Route Info Overview -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                        <div class="flex items-center text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-user-hard-hat mr-2 text-primary-500"></i>
                            <span class="text-sm">Sürücü:</span>
                            <span class="ml-auto font-medium">@GetDriverName(selectedRoute.DriverId)</span>
                        </div>
                        <div class="flex items-center text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-truck mr-2 text-blue-500"></i>
                            <span class="text-sm">Araç:</span>
                            <span class="ml-auto font-medium">@GetVehiclePlate(selectedRoute.VehicleId)</span>
                        </div>
                        <div class="flex items-center text-gray-700 dark:text-gray-300">
                            <i class="fas fa-trash-alt mr-2 text-green-500"></i>
                            <span class="text-sm">Atık Tipi:</span>
                            <span class="ml-auto font-medium">@selectedRoute.WasteType</span>
                        </div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                        <div class="flex items-center text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-calendar-alt mr-2 text-yellow-500"></i>
                            <span class="text-sm">Başlangıç:</span>
                            <span class="ml-auto font-medium">@selectedRoute.StartTime.ToString("dd.MM.yyyy HH:mm")</span>
                        </div>
                        <div class="flex items-center text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-road mr-2 text-purple-500"></i>
                            <span class="text-sm">Mesafe:</span>
                            <span class="ml-auto font-medium">@selectedRoute.TotalDistanceKm.ToString("F1") km</span>
                        </div>
                        <div class="flex items-center text-gray-700 dark:text-gray-300">
                            <i class="fas fa-clock mr-2 text-orange-500"></i>
                            <span class="text-sm">Süre:</span>
                            <span class="ml-auto font-medium">@selectedRoute.EstimatedDurationMin dk</span>
                        </div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg flex flex-col justify-between">
                        <div class="flex items-center text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-chart-pie mr-2 text-red-500"></i>
                            <span class="text-sm">Durum:</span>
                            <span class="ml-auto">
                                <span class="@GetStatusBadgeClass(selectedRoute.Status) px-2 py-1 rounded-full text-xs">
                                    @GetStatusText(selectedRoute.Status)
                                </span>
                            </span>
                        </div>
                        <div class="flex items-center text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-sort-amount-down mr-2 text-indigo-500"></i>
                            <span class="text-sm">Optimizasyon:</span>
                            <span class="ml-auto font-medium">@GetOptimizationTypeText(selectedRoute.OptimizationType)</span>
                        </div>
                        <div class="flex items-center text-gray-700 dark:text-gray-300">
                            <i class="fas fa-map-marked-alt mr-2 text-teal-500"></i>
                            <span class="text-sm">Adımlar:</span>
                            <span class="ml-auto font-medium">@selectedRoute.Steps.Count() adet</span>
                        </div>
                    </div>
                </div>

                <!-- Çevresel Etki -->
                <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow-md mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4 flex items-center">
                        <i class="fas fa-leaf mr-2 text-green-500"></i> Çevresel Etki
                    </h3>

                    <div class="space-y-3">
                        <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-2">
                            <span class="text-sm text-gray-500 dark:text-gray-400">Tahmini Yakıt Tüketimi:</span>
                            <span class="text-sm font-medium text-gray-800 dark:text-gray-200">@selectedRoute.EstimatedFuelL.ToString("F2") L</span>
                        </div>
                        <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-2">
                            <span class="text-sm text-gray-500 dark:text-gray-400">Tahmini CO2 Emisyonu:</span>
                            <span class="text-sm font-medium text-gray-800 dark:text-gray-200">@selectedRoute.EstimatedCO2Kg.ToString("F2") kg</span>
                        </div>
                    </div>
                </div>

                <!-- Map -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden mb-6">
                    <div class="p-4 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600 flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center">
                            <i class="fas fa-map-marked-alt mr-2 text-primary-500"></i> Rota Haritası
                        </h3>
                        <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center">
                            <i class="fas fa-map-pin mr-1 text-red-500"></i> Adım sayısı: @selectedRoute.Steps.Count()
                        </div>
                    </div>
                    <div id="route-map" class="w-full h-80"></div>
                </div>

                <!-- Simulation Controls -->
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4 flex items-center">
                        <i class="fas fa-play-circle mr-2 text-green-500"></i> Rota Simülasyonu
                    </h3>

                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div class="flex space-x-2">
                            <button id="start-simulation" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md flex items-center transition-colors">
                                <i class="fas fa-play mr-2"></i> Başlat
                            </button>
                            <button id="pause-simulation" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md flex items-center transition-colors">
                                <i class="fas fa-pause mr-2"></i> Duraklat
                            </button>
                            <button id="stop-simulation" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md flex items-center transition-colors">
                                <i class="fas fa-stop mr-2"></i> Durdur
                            </button>
                        </div>

                        <div class="flex flex-col">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-gray-600 dark:text-gray-300 text-sm">Hız: <span id="speed-value">1x</span></span>
                                <div class="flex space-x-1">
                                    <button id="speed-min" class="bg-gray-200 text-gray-700 px-2 py-0.5 rounded text-xs">Min</button>
                                    <button id="speed-max" class="bg-gray-200 text-gray-700 px-2 py-0.5 rounded text-xs">Max</button>
                                </div>
                            </div>
                            <input type="range" id="speed-slider" min="1" max="10" value="1"
                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                        </div>
                    </div>

                    <!-- Simulation Progress -->
                    <div class="mt-4">
                        <div class="flex justify-between items-center text-sm text-gray-500 dark:text-gray-400 mb-2">
                            <span>İlerleme: <span id="progress-percentage">0%</span></span>
                            <span>Tahmini kalan süre: <span id="remaining-time">@selectedRoute.EstimatedDurationMin dk</span></span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-3">
                            <div id="progress-bar" class="bg-primary-500 h-3 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Steps Table -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden mb-4">
                    <div class="p-4 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center">
                            <i class="fas fa-list-check mr-2 text-purple-500"></i> Rota Adımları
                        </h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">No</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Adres</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Konum</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Durum</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 dark:divide-gray-700" id="route-steps-table">
                                @foreach (var step in selectedRoute.Steps.OrderBy(s => s.Order))
                                {
                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700" data-step-id="@step.Id">
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">@step.Order</td>
                                        <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">@step.Address</td>
                                        <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">(@step.Latitude.ToString("F4"), @step.Longitude.ToString("F4"))</td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <span class="@(step.IsCompleted ? "bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300" : "bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-300") px-2 py-0.5 rounded-full text-xs">
                                                @(step.IsCompleted ? "Tamamlandı" : "Beklemede")
                                            </span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex justify-between items-center pt-4 border-t border-gray-200 dark:border-gray-700">
                    @if (selectedRoute.Status != RouteStatus.Completed)
                    {
                        <div class="flex space-x-2">
                            <button class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition-colors flex items-center" @onclick="() => CompleteRoute(selectedRoute.Id)">
                                <i class="fas fa-check-circle mr-2"></i> Rotayı Tamamla
                            </button>
                            <button class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md transition-colors flex items-center" @onclick="() => ReoptimizeWithTraffic(selectedRoute.Id)">
                                <i class="fas fa-traffic-light mr-2"></i> Trafik ile Yeniden Optimize Et
                            </button>
                        </div>
                    }
                    else
                    {
                        <div></div>
                    }
                    <button class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-md transition-colors" @onclick="CloseModal">
                        Kapat
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Create Route Modal -->
@if (showCreateModal)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto animate-modal-show">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700 sticky top-0 bg-white dark:bg-gray-800 z-10">
                <h2 class="text-xl font-semibold text-gray-800 dark:text-white flex items-center">
                    <i class="fas fa-route mr-3 text-primary-500"></i> Yeni Rota Oluştur
                </h2>
                <button class="text-gray-500 hover:text-red-600" @onclick="CloseCreateModal">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="p-6">
                <EditForm Model="newRoute" OnValidSubmit="CreateRoute">
                    <!-- Temel Bilgiler -->
                    <div class="bg-gray-50 dark:bg-gray-700 p-5 rounded-lg mb-5">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4 flex items-center border-b border-gray-200 dark:border-gray-600 pb-2">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i> Temel Bilgiler
                        </h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Rota Adı</label>
                                <InputText class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" @bind-Value="newRoute.RouteName" placeholder="Örn: Sabah Rotası" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Atık Türü</label>
                                <InputSelect class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                                             @bind-Value="newRoute.WasteType">
                                    <option value="">Seçiniz</option>
                                    @foreach (WasteType wt in Enum.GetValues(typeof(WasteType)))
                                    {
                                        <option value="@wt">@GetWasteTypeText(wt)</option>
                                    }
                                </InputSelect>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Başlangıç Zamanı</label>
                                <InputDate class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" @bind-Value="newRoute.ScheduledStart" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Optimizasyon Türü</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="relative">
                                        <input type="radio" id="opt-shortest" name="optimization-type" value="@OptimizationType.EnKisaMesafe"
                                               checked="@(newRoute.OptimizationType == OptimizationType.EnKisaMesafe)"
                                               @onchange='@(() => newRoute.OptimizationType = OptimizationType.EnKisaMesafe)'
                                               class="hidden peer" />
                                        <label for="opt-shortest" class="inline-flex items-center justify-center w-full p-3 text-gray-700 bg-white border border-gray-200 rounded-lg cursor-pointer dark:hover:text-gray-300 dark:border-gray-700 dark:peer-checked:text-blue-400 peer-checked:border-blue-600 peer-checked:text-blue-600 hover:text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:bg-gray-800 dark:hover:bg-gray-700">
                                            <i class="fas fa-route mr-2 text-blue-500"></i>
                                            <span class="font-medium text-sm">En Kısa Mesafe</span>
                                        </label>
                                    </div>
                                    <div class="relative">
                                        <input type="radio" id="opt-fill" name="optimization-type" value="@OptimizationType.DolulukOncelikli"
                                               checked="@(newRoute.OptimizationType == OptimizationType.DolulukOncelikli)"
                                               @onchange='@(() => newRoute.OptimizationType = OptimizationType.DolulukOncelikli)'
                                               class="hidden peer" />
                                        <label for="opt-fill" class="inline-flex items-center justify-center w-full p-3 text-gray-700 bg-white border border-gray-200 rounded-lg cursor-pointer dark:hover:text-gray-300 dark:border-gray-700 dark:peer-checked:text-green-400 peer-checked:border-green-600 peer-checked:text-green-600 hover:text-gray-600 hover:bg-gray-100 dark:text-gray-400 dark:bg-gray-800 dark:hover:bg-gray-700">
                                            <i class="fas fa-fill-drip mr-2 text-green-500"></i>
                                            <span class="font-medium text-sm">Doluluk Öncelikli</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Başlangıç Noktası -->
                    <div class="bg-gray-50 dark:bg-gray-700 p-5 rounded-lg mb-5">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4 flex items-center border-b border-gray-200 dark:border-gray-600 pb-2">
                            <i class="fas fa-map-marker-alt mr-2 text-red-500"></i> Başlangıç/Bitiş Noktası
                        </h3>

                        <div class="flex items-center mb-3 bg-blue-50 dark:bg-blue-900/20 text-blue-800 dark:text-blue-300 p-3 rounded-lg">
                            <i class="fas fa-info-circle mr-2 text-xl"></i>
                            <p class="text-sm">Tüm rotalar aynı noktadan başlayıp aynı noktada bitecektir.</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex items-center">
                                <i class="fas fa-map-marker-alt text-red-500 mr-2 text-xl"></i>
                                <div>
                                    <span class="text-gray-700 dark:text-gray-300 font-medium">Çorlu Belediyesi</span>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">@fixedStartLat.ToString("F6"), @fixedStartLng.ToString("F6")</p>
                                </div>
                            </div>
                            <div id="start-point-mini-map" class="h-24 rounded-md overflow-hidden border border-gray-300 dark:border-gray-600"></div>
                        </div>
                    </div>

                    <!-- Sürücü ve Araç Seçimi -->
                    <div class="bg-gray-50 dark:bg-gray-700 p-5 rounded-lg mb-5">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4 flex items-center border-b border-gray-200 dark:border-gray-600 pb-2">
                            <i class="fas fa-users mr-2 text-amber-500"></i> Sürücü ve Araç
                        </h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                          <!-- Sürücü Seçimi -->
<div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Sürücü Seçimi</label>
    <div class="grid grid-cols-1 gap-2 max-h-48 overflow-y-auto p-2 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
        @if (availableDrivers != null && availableDrivers.Any())
        {
            foreach (var driver in availableDrivers)
            {
                <div class="flex items-center p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors border border-gray-100 dark:border-gray-800 @(newRoute.DriverId == driver.Id ? "bg-blue-50 border-blue-300 dark:bg-blue-900/20 dark:border-blue-600" : "")"
                     @onclick="@(() => newRoute.DriverId = driver.Id)">
                    <input type="radio"
                           id="driver-@driver.Id"
                           name="driver-selection"
                           value="@driver.Id"
                           checked="@(newRoute.DriverId == driver.Id)"
                           @onchange="@(e => newRoute.DriverId = driver.Id)"
                           class="w-4 h-4 mr-3 text-primary-600 bg-gray-100 border-gray-300 rounded-full focus:ring-primary-500 dark:focus:ring-primary-600 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" />
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-primary-500 rounded-full text-white flex items-center justify-center mr-3">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-800 dark:text-white">@driver.Name @driver.Surname</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">@driver.PhoneNumber</p>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="text-center py-4 text-gray-500 dark:text-gray-400">
                <i class="fas fa-users-slash text-3xl mb-2"></i>
                <p>Kullanılabilir sürücü bulunamadı</p>
            </div>
        }
    </div>
</div>

<!-- Araç Seçimi -->
<div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Araç Seçimi</label>
    <div class="grid grid-cols-1 gap-2 max-h-48 overflow-y-auto p-2 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
        @if (availableVehicles != null && availableVehicles.Any())
        {
            foreach (var vehicle in availableVehicles)
            {
                <div class="flex items-center p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors border border-gray-100 dark:border-gray-800 @(newRoute.VehicleId == vehicle.Id.ToString() ? "bg-blue-50 border-blue-300 dark:bg-blue-900/20 dark:border-blue-600" : "")"
                     @onclick="@(() => newRoute.VehicleId = vehicle.Id.ToString())">
                    <input type="radio"
                           id="vehicle-@vehicle.Id"
                           name="vehicle-selection"
                           value="@vehicle.Id.ToString()"
                           checked="@(newRoute.VehicleId == vehicle.Id.ToString())"
                           @onchange="@(e => newRoute.VehicleId = vehicle.Id.ToString())"
                           class="w-4 h-4 mr-3 text-primary-600 bg-gray-100 border-gray-300 rounded-full focus:ring-primary-500 dark:focus:ring-primary-600 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" />
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-blue-500 rounded-full text-white flex items-center justify-center mr-3">
                            <i class="fas fa-truck"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-800 dark:text-white">@vehicle.Plate</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">@vehicle.Description</p>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="text-center py-4 text-gray-500 dark:text-gray-400">
                <i class="fas fa-truck-slash text-3xl mb-2"></i>
                <p>Kullanılabilir araç bulunamadı</p>
            </div>
        }
    </div>
</div>
                        </div>
                    </div>

                    <!-- Atık Kutuları Seçimi -->
                    <div class="bg-gray-50 dark:bg-gray-700 p-5 rounded-lg mb-5">
                        <div class="flex justify-between items-center mb-4 border-b border-gray-200 dark:border-gray-600 pb-2">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center">
                                <i class="fas fa-dumpster mr-2 text-green-500"></i> Atık Kutuları
                            </h3>
                            <span class="bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-300 text-xs px-2 py-1 rounded-full">
                                @newRoute.WasteBinIds.Count adet seçildi
                            </span>
                        </div>

                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg max-h-72 overflow-y-auto">
                            <div class="mb-3 relative">
                                <input type="text" placeholder="Atık kutusu ara..."
                                       @bind="binSearchText" @bind:event="oninput" @onkeyup="FilterBinsWithDebounce"
                                       class="w-full px-3 py-2 pl-10 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" />
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                @foreach (var bin in filteredBins)
                                {
                                    <div class="flex items-center space-x-2 p-3 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-700 transition-colors @(newRoute.WasteBinIds.Contains(bin.Id) ? "bg-blue-50 border-blue-300 dark:bg-blue-900/20 dark:border-blue-600" : "")"
                                         @onclick="e => ToggleBin(bin.Id, !newRoute.WasteBinIds.Contains(bin.Id))">
                                        <input type="checkbox"
                                               id="bin-@bin.Id"
                                               value="@bin.Id"
                                               checked="@newRoute.WasteBinIds.Contains(bin.Id)"
                                               @onchange="e => ToggleBin(bin.Id, e.Value)"
                                               class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500 dark:focus:ring-primary-600 dark:bg-gray-700 dark:border-gray-600" />
                                        <div class="flex-1">
                                            <div class="flex justify-between">
                                                <span class="font-medium text-gray-800 dark:text-white text-sm">@bin.Label</span>
                                                <span class="@GetFillLevelBadgeClass(bin.FillLevel) text-xs px-2 py-0.5 rounded-full">
                                                    @(bin.FillLevel?.ToString("F0") ?? "0")%
                                                </span>
                                            </div>
                                            <span class="text-xs text-gray-500 dark:text-gray-400 line-clamp-1">@bin.Address</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Notlar -->
                    <div class="bg-gray-50 dark:bg-gray-700 p-5 rounded-lg mb-5">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4 flex items-center border-b border-gray-200 dark:border-gray-600 pb-2">
                            <i class="fas fa-sticky-note mr-2 text-yellow-500"></i> Notlar
                        </h3>

                        <textarea class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white resize-none focus:outline-none focus:ring-primary-500 focus:border-primary-500"
                                  @bind="newRoute.Notes"
                                  rows="3"
                                  placeholder="Rotayla ilgili notlarınızı buraya ekleyebilirsiniz..."></textarea>
                    </div>

                    <!-- Özet ve Butonlar -->
                    <div class="flex flex-col-reverse md:flex-row justify-between items-start md:items-center gap-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <div class="space-y-2 text-sm text-gray-600 dark:text-gray-400">
                            <div class="flex items-center">
                                <i class="fas fa-route text-primary-500 mr-2"></i>
                                <span>Optimizasyon: @GetOptimizationTypeText(newRoute.OptimizationType)</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-dumpster text-green-500 mr-2"></i>
                                <span>Seçilen Atık Kutusu: @newRoute.WasteBinIds.Count adet</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-map-marker-alt text-red-500 mr-2"></i>
                                <span>Başlangıç Noktası: Çorlu Belediyesi</span>
                            </div>
                        </div>
                        <div class="flex space-x-3">
                            <button type="button" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors" @onclick="CloseCreateModal">
                                İptal
                            </button>
                            <button type="submit" class="px-5 py-2 bg-primary-500 text-white rounded-md hover:bg-primary-600 transition-colors shadow-sm">
                                <i class="fas fa-check mr-2"></i> Rota Oluştur
                            </button>
                        </div>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

<style>
    /* Tooltip Styles */
    .tooltip-container {
        position: relative;
    }

        .tooltip-container .tooltip {
            visibility: hidden;
            background-color: rgba(0,0,0,0.8);
            color: white;
            text-align: center;
            border-radius: 4px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
            font-size: 12px;
        }

            .tooltip-container .tooltip::after {
                content: "";
                position: absolute;
                top: 100%;
                left: 50%;
                margin-left: -5px;
                border-width: 5px;
                border-style: solid;
                border-color: rgba(0,0,0,0.8) transparent transparent transparent;
            }

        .tooltip-container:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

    /* Row Expansion Animation */
    @@keyframes expandRow {
        from {
            opacity: 0;
            max-height: 0;
            transform: scaleY(0);
            transform-origin: top;
        }

        to {
            opacity: 1;
            max-height: 1000px;
            transform: scaleY(1);
            transform-origin: top;
        }
    }

    .animate-expandRow {
        animation: expandRow 0.3s ease-out forwards;
    }

    /* Modal Animation */
    @@keyframes modalShow {
        from {
            opacity: 0;
            transform: scale(0.95) translateY(10px);
        }

        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .animate-modal-show {
        animation: modalShow 0.2s ease-out forwards;
    }

    /* Map InfoWindow Styles */
    :global(.gm-style .gm-style-iw-c) {
        padding: 0 !important;
        border-radius: 8px !important;
        box-shadow: 0 6px 16px rgba(0,0,0,0.15) !important;
    }

    :global(.gm-style .gm-style-iw-d) {
        overflow: hidden !important;
    }

    /* Pulse animation for markers */
    @@keyframes markerPulse {
        0% {
            transform: scale(1);
            opacity: 1;
        }

        50% {
            transform: scale(1.1);
            opacity: 0.9;
        }

        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    .marker-pulse {
        animation: markerPulse 1.5s infinite;
    }

    /* Line clamp for address text */
    .line-clamp-1 {
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>


<script>
    // Global variables
    let mainMap;
    let locationPickerMap;
    let markers = [];
    let routePolylines = [];
    let truckMarkers = [];
    let wasteBinMarkers = [];
    let markerCluster = null;
    let currentInfoWindow = null;
    let sidebarOpen = false;
    let dotNetRef = null;
    let selectedRouteId = null;
    let userLocationMarker = null;
    let isDarkMode = false;
    let simulationVehicleMarker = null;
    let simulationNotificationSent = false;
    let alreadyNotifiedSteps = [];

    // Constants
    const DEFAULT_CENTER = { lat: 41.1634, lng: 27.7951 }; // Çorlu merkez
    const DEFAULT_ZOOM = 13;
    const FOCUS_ZOOM = 15;
    const DETAIL_ZOOM = 14;
    const DEFAULT_TILT = 67.7;
    const MAP_ID = '8b70db4a26fb9f4cd11929e3';
    const PRIMARY_COLOR = '#3B82F6';
    const RECYCLING_GREEN = "#10B981";

    // Add the missing scrollToRouteMap function
    window.scrollToRouteMap = function() {
        const mapElement = document.getElementById('route-map');
        if (mapElement) {
            mapElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    };

    // Dark mode detection
    function detectDarkMode() {
        isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ||
                   document.documentElement.classList.contains('dark');
        return isDarkMode;
    }

    // Watch for dark mode changes
    if (window.matchMedia) {
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            isDarkMode = e.matches || document.documentElement.classList.contains('dark');
            updateMapTheme();
        });
    }

    // Observer for dark class changes
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                const newDarkMode = document.documentElement.classList.contains('dark');
                if (newDarkMode !== isDarkMode) {
                    isDarkMode = newDarkMode;
                    updateMapTheme();
                }
            }
        });
    });

    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class']
    });

    function updateMapTheme() {
        if (mainMap) {
            mainMap.setOptions({
                styles: getMapStyles()
            });
        }
        if (locationPickerMap) {
            locationPickerMap.setOptions({
                styles: getMapStyles()
            });
        }
    }

    function getMapStyles() {
        detectDarkMode();

        if (isDarkMode) {
            return [
                { elementType: "geometry", stylers: [{ color: "#0f0f0f" }] },
                { elementType: "labels.text.stroke", stylers: [{ color: "#0f0f0f" }] },
                { elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
                {
                    featureType: "administrative.locality",
                    elementType: "labels.text.fill",
                    stylers: [{ color: "#c4c4c4" }]
                },
                {
                    featureType: "administrative.country",
                    elementType: "geometry.stroke",
                    stylers: [{ color: "#4e5c6e" }]
                },
                {
                    featureType: "poi",
                    elementType: "labels.text.fill",
                    stylers: [{ color: "#6b7280" }]
                },
                {
                    featureType: "poi.park",
                    elementType: "geometry.fill",
                    stylers: [{ color: "#1a2e1a" }]
                },
                {
                    featureType: "poi.business",
                    stylers: [{ visibility: "off" }]
                },
                {
                    featureType: "road",
                    elementType: "geometry",
                    stylers: [{ color: "#1f1f1f" }]
                },
                {
                    featureType: "road",
                    elementType: "geometry.stroke",
                    stylers: [{ color: "#0a0a0a" }]
                },
                {
                    featureType: "road.highway",
                    elementType: "geometry",
                    stylers: [{ color: "#2d2d2d" }]
                },
                {
                    featureType: "road.highway",
                    elementType: "geometry.stroke",
                    stylers: [{ color: "#1a1a1a" }]
                },
                {
                    featureType: "road.arterial",
                    elementType: "geometry",
                    stylers: [{ color: "#262626" }]
                },
                {
                    featureType: "road.local",
                    elementType: "geometry",
                    stylers: [{ color: "#1a1a1a" }]
                },
                {
                    featureType: "water",
                    elementType: "geometry.fill",
                    stylers: [{ color: "#0a1a2a" }]
                },
                {
                    featureType: "water",
                    elementType: "labels.text.fill",
                    stylers: [{ color: "#4a90a4" }]
                },
                {
                    featureType: "transit",
                    elementType: "geometry",
                    stylers: [{ color: "#1e1e1e" }]
                },
                {
                    featureType: "transit.station",
                    elementType: "labels.text.fill",
                    stylers: [{ color: "#757575" }]
                },
                {
                    featureType: "landscape.man_made",
                    elementType: "geometry.fill",
                    stylers: [{ color: "#1a1a1a" }]
                },
                {
                    featureType: "landscape.natural",
                    elementType: "geometry.fill",
                    stylers: [{ color: "#0d0d0d" }]
                }
            ];
        } else {
            return [
                {
                    "featureType": "all",
                    "elementType": "geometry",
                    "stylers": [{"color": "#f5f5f5"}]
                },
                {
                    "featureType": "landscape.man_made",
                    "elementType": "geometry.fill",
                    "stylers": [{"color": "#e8f0e4"}]
                },
                {
                    "featureType": "poi.park",
                    "elementType": "geometry.fill",
                    "stylers": [{"color": "#c8e6c9"}]
                },
                {
                    "featureType": "water",
                    "elementType": "geometry.fill",
                    "stylers": [{"color": "#bbdefb"}]
                },
                {
                    "featureType": "road",
                    "elementType": "geometry.fill",
                    "stylers": [{"color": "#ffffff"}]
                },
                {
                    "featureType": "road",
                    "elementType": "geometry.stroke",
                    "stylers": [{"color": "#e0e0e0"}]
                }
            ];
        }
    }

       // Enhanced icon creation functions - Updated depot icon with larger building icon
       function getDepotIcon(scale = 1.5) {
        const size = 45 * scale;
        const color = isDarkMode ? '#F59E0B' : '#D97706';
        const strokeColor = isDarkMode ? '#FBBF24' : '#B45309';

        const svg = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${size + 16} ${size + 20}" width="${size + 16}" height="${size + 20}">
                <defs>
                    <filter id="shadow-depot" x="-50%" y="-50%" width="200%" height="200%">
                        <feDropShadow dx="0" dy="4" stdDeviation="6" flood-opacity="0.5"/>
                    </filter>
                    <radialGradient id="grad-depot" cx="30%" cy="30%" r="70%">
                        <stop offset="0%" style="stop-color:${color};stop-opacity:1" />
                        <stop offset="100%" style="stop-color:${strokeColor};stop-opacity:1" />
                    </radialGradient>
                </defs>

                <!-- Main pin circle -->
                <circle cx="${(size + 16) / 2}" cy="${size / 2 + 8}" r="${size / 2}"
                        fill="url(#grad-depot)"
                        stroke="white"
                        stroke-width="4"
                        opacity="0.95"
                        filter="url(#shadow-depot)"/>

                <!-- Pin point -->
                <path d="M${(size + 16) / 2},${size + 8} L${(size + 16) / 2 + 8},${size + 20} L${(size + 16) / 2 - 8},${size + 20} Z"
                      fill="url(#grad-depot)"
                      stroke="white"
                      stroke-width="3"/>

                <!-- Updated municipal building icon - Perfectly centered within circle -->
                <g transform="translate(${(size + 16) / 2}, ${size / 2 + 8}) scale(1.9) translate(-12,-12)">
                    <!-- Main building -->
                    <rect x="3" y="12" width="18" height="10" fill="white" opacity="0.95" rx="1"/>
                    <!-- Roof -->
                    <polygon points="12,4 3,10 21,10" fill="white" opacity="0.95"/>
                    <!-- Columns -->
                    <rect x="5" y="13" width="2" height="8" fill="${color}" opacity="0.8"/>
                    <rect x="9" y="13" width="2" height="8" fill="${color}" opacity="0.8"/>
                    <rect x="13" y="13" width="2" height="8" fill="${color}" opacity="0.8"/>
                    <rect x="17" y="13" width="2" height="8" fill="${color}" opacity="0.8"/>
                    <!-- Flag pole -->
                    <rect x="11" y="4" width="1.5" height="6" fill="white" opacity="0.9"/>
                    <!-- Flag -->
                    <polygon points="12.5,4 12.5,7 18,6 12.5,5" fill="#DC2626" opacity="0.9"/>
                    <!-- Door -->
                    <rect x="10" y="17" width="4" height="4" fill="${color}" opacity="0.9" rx="0.5"/>
                    <!-- Windows -->
                    <rect x="6" y="14" width="1.5" height="1.5" fill="${color}" opacity="0.6"/>
                    <rect x="16" y="14" width="1.5" height="1.5" fill="${color}" opacity="0.6"/>
                </g>
            </svg>
        `;

        return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
    }
    function getTruckIcon(routeColor = '#4285F4', scale = 1.5) {
        const size = 36 * scale;
        const strokeColor = darkenColor(routeColor, 20);

        const svg = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${size + 16} ${size + 20}" width="${size + 16}" height="${size + 20}">
                <defs>
                    <filter id="shadow-truck" x="-50%" y="-50%" width="200%" height="200%">
                        <feDropShadow dx="0" dy="3" stdDeviation="4" flood-opacity="0.4"/>
                    </filter>
                    <radialGradient id="grad-truck" cx="30%" cy="30%" r="70%">
                        <stop offset="0%" style="stop-color:${routeColor};stop-opacity:1" />
                        <stop offset="100%" style="stop-color:${strokeColor};stop-opacity:1" />
                    </radialGradient>
                </defs>

                <!-- Main pin circle -->
                <circle cx="${(size + 16) / 2}" cy="${size / 2 + 8}" r="${size / 2}"
                        fill="url(#grad-truck)"
                        stroke="white"
                        stroke-width="3"
                        opacity="0.95"
                        filter="url(#shadow-truck)"/>

                <!-- Pin point -->
                <path d="M${(size + 16) / 2},${size + 8} L${(size + 16) / 2 + 6},${size + 18} L${(size + 16) / 2 - 6},${size + 18} Z"
                      fill="url(#grad-truck)"
                      stroke="white"
                      stroke-width="2"/>

                <!-- Truck icon -->
                <g transform="translate(${(size + 16) / 2 - 10}, ${size / 2 + 8 - 10}) scale(1.2)">
                    <!-- Truck body -->
                    <rect x="2" y="8" width="12" height="8" fill="white" opacity="0.9" rx="1"/>
                    <!-- Truck cab -->
                    <rect x="14" y="10" width="6" height="6" fill="white" opacity="0.9" rx="1"/>
                    <!-- Windows -->
                    <rect x="3" y="9" width="4" height="3" fill="${routeColor}" opacity="0.7"/>
                    <rect x="15" y="11" width="3" height="3" fill="${routeColor}" opacity="0.7"/>
                    <!-- Wheels -->
                    <circle cx="5" cy="17" r="1.5" fill="white" opacity="0.9"/>
                    <circle cx="11" cy="17" r="1.5" fill="white" opacity="0.9"/>
                    <circle cx="17" cy="17" r="1.5" fill="white" opacity="0.9"/>
                </g>
            </svg>
        `;

        return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
    }

    // Updated waste bin icon with larger size
    function getWasteBinIcon(status, fillLevel, opacity = 1, scale = 1.8) { // Increased default scale from 1.0 to 1.4
        let fillColor, strokeColor;

        if (fillLevel >= 90) {
            fillColor = '#EF4444';
            strokeColor = '#B91C1C';
        } else if (fillLevel >= 70) {
            fillColor = '#F97316';
            strokeColor = '#C2410C';
        } else if (fillLevel >= 50) {
            fillColor = '#F59E0B';
            strokeColor = '#B45309';
        } else if (fillLevel >= 30) {
            fillColor = PRIMARY_COLOR;
            strokeColor = '#1D4ED8';
        } else {
            fillColor = '#10B981';
            strokeColor = '#059669';
        }

        if (status === 'Inactive') {
            fillColor = '#9CA3AF';
            strokeColor = '#6B7280';
        } else if (status === 'Maintenance') {
            fillColor = '#FBBF24';
            strokeColor = '#D97706';
        } else if (status === 'Faulty') {
            fillColor = '#F87171';
            strokeColor = '#DC2626';
        }

        const size = 32 * scale; // Increased base size from 28 to 32
        const iconSize = 16 * scale; // Increased icon size from 14 to 16

        const svg = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${size + 12} ${size + 16}" width="${size + 12}" height="${size + 16}">
                <defs>
                    <filter id="shadow-bin" x="-50%" y="-50%" width="200%" height="200%">
                        <feDropShadow dx="0" dy="3" stdDeviation="4" flood-opacity="0.4"/>
                    </filter>
                    <radialGradient id="grad-bin" cx="50%" cy="30%" r="70%">
                        <stop offset="0%" style="stop-color:${fillColor};stop-opacity:1" />
                        <stop offset="100%" style="stop-color:${strokeColor};stop-opacity:1" />
                    </radialGradient>
                </defs>

                <!-- Main pin circle -->
                <circle cx="${(size + 12) / 2}" cy="${size / 2 + 6}" r="${size / 2}"
                        fill="url(#grad-bin)"
                        stroke="white"
                        stroke-width="3"
                        opacity="${opacity}"
                        filter="url(#shadow-bin)"/>

                <!-- Pin point -->
                <path d="M${(size + 12) / 2},${size + 6} L${(size + 12) / 2 + 6},${size + 16} L${(size + 12) / 2 - 6},${size + 16} Z"
                      fill="url(#grad-bin)"
                      stroke="white"
                      stroke-width="2"/>

                <!-- Trash bin icon -->
                <g transform="translate(${(size + 12) / 2 - iconSize / 2}, ${size / 2 + 6 - iconSize / 2}) scale(${iconSize / 16})">
                    <rect x="2" y="5" width="12" height="9" rx="1" fill="white" opacity="0.9"/>
                    <rect x="1" y="4" width="14" height="2" rx="1" fill="white" opacity="0.9"/>
                    <rect x="6" y="2" width="4" height="3" rx="1" fill="white" opacity="0.7"/>
                    <rect x="3" y="${14 - (fillLevel / 100) * 8}" width="10" height="${(fillLevel / 100) * 8}"
                          fill="${fillColor}" opacity="0.3" rx="0.5"/>
                    <!-- Lid handle -->
                    <ellipse cx="8" cy="3" rx="1" ry="0.5" fill="white" opacity="0.8"/>
                    <!-- Waste level indicator lines -->
                    <line x1="4" y1="7" x2="12" y2="7" stroke="${fillColor}" stroke-width="0.3" opacity="0.6"/>
                    <line x1="4" y1="9" x2="12" y2="9" stroke="${fillColor}" stroke-width="0.3" opacity="0.6"/>
                    <line x1="4" y1="11" x2="12" y2="11" stroke="${fillColor}" stroke-width="0.3" opacity="0.6"/>
                </g>
            </svg>
        `;

        return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
    }

    // Helper function to darken colors
    function darkenColor(color, percent) {
        const hex = color.replace('#', '');
        const num = parseInt(hex, 16);
        const amt = Math.round(2.55 * percent);
        const R = Math.max(0, Math.min(255, (num >> 16) - amt));
        const G = Math.max(0, Math.min(255, (num >> 8 & 0x00FF) - amt));
        const B = Math.max(0, Math.min(255, (num & 0x0000FF) - amt));
        return "#" + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
    }

    // Initialize Google Maps integration
    window.initializeGoogleMaps = function (reference) {
        dotNetRef = reference;
        detectDarkMode();
        console.log("Google Maps initialization started");
    };

    // Main object containing all Google Maps related functions
    window.googleMapsInterop = {
        initializeMainMap: function () {
            const mapElementId = "admin-observer-map";
            console.log("Initializing main map in element:", mapElementId);

            const mapElement = document.getElementById(mapElementId);
            if (!mapElement) {
                console.error("Main map element not found:", mapElementId);
                return false;
            }

            const hideLoading = () => {
                const loadingIndicator = document.getElementById('map-loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.style.opacity = '0';
                    setTimeout(() => {
                        loadingIndicator.style.display = 'none';
                    }, 500);
                }
            };

            try {
                mainMap = new google.maps.Map(mapElement, {
                    center: DEFAULT_CENTER,
                    zoom: DEFAULT_ZOOM,
                    tilt: DEFAULT_TILT,
                    heading: 0,
                    mapTypeId: 'roadmap',
                    mapId: MAP_ID,
                    streetViewControl: false,
                    mapTypeControl: false,
                    rotateControl: true,
                    zoomControl: true,
                    fullscreenControl: true,
                    styles: getMapStyles()
                });

                this.add3DToggle(mainMap);
                this.addUserLocationButton(mainMap);

                google.maps.event.addListenerOnce(mainMap, 'tilesloaded', () => {
                    hideLoading();
                    if (dotNetRef) {
                        dotNetRef.invokeMethodAsync('OnMapInitialized');
                    }
                });

                return true;
            } catch (error) {
                console.error("Error initializing main map:", error);
                hideLoading();
                return false;
            }
        },

        add3DToggle: function (map) {
            const toggleButton = document.createElement('button');
            toggleButton.className = 'custom-map-control-button toggle-view-button';
            toggleButton.innerHTML = '<i class="fas fa-cube"></i> 3D';
            toggleButton.title = 'Toggle 2D/3D view';

            let is3DMode = true;

            toggleButton.addEventListener('click', () => {
                if (is3DMode) {
                    map.setTilt(0);
                    toggleButton.innerHTML = '<i class="fas fa-map"></i> 2D';
                } else {
                    map.setTilt(DEFAULT_TILT);
                    toggleButton.innerHTML = '<i class="fas fa-cube"></i> 3D';
                }
                is3DMode = !is3DMode;
            });

            map.controls[google.maps.ControlPosition.TOP_RIGHT].push(toggleButton);

            const style = document.createElement('style');
            style.textContent = `
                .toggle-view-button {
                    background-color: ${isDarkMode ? '#1F2937' : '#fff'};
                    border: 2px solid ${isDarkMode ? '#374151' : '#fff'};
                    border-radius: 6px;
                    box-shadow: 0 3px 8px rgba(0,0,0,.2);
                    color: ${isDarkMode ? '#E5E7EB' : '#555'};
                    cursor: pointer;
                    font-family: 'Inter', -apple-system, sans-serif;
                    font-size: 14px;
                    font-weight: 500;
                    margin: 10px;
                    padding: 10px 16px;
                    text-align: center;
                    transition: all 0.3s ease;
                }
                .toggle-view-button:hover {
                    background-color: ${isDarkMode ? '#374151' : '#f8f9fa'};
                    transform: translateY(-1px);
                    box-shadow: 0 4px 12px rgba(0,0,0,.25);
                }
                .toggle-view-button i {
                    margin-right: 6px;
                }
            `;
            document.head.appendChild(style);
        },

        addUserLocationButton: function (map) {
            const locationButton = document.createElement('button');
            locationButton.className = 'custom-map-control-button location-button';
            locationButton.innerHTML = '<i class="fas fa-location-arrow"></i>';
            locationButton.title = 'Show my location';

            locationButton.addEventListener('click', () => {
                if (navigator.geolocation) {
                    locationButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                            };

                            if (userLocationMarker) {
                                userLocationMarker.setMap(null);
                            }

                            userLocationMarker = new google.maps.Marker({
                                position: pos,
                                map: map,
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    fillColor: PRIMARY_COLOR,
                                    fillOpacity: 1,
                                    strokeColor: '#FFFFFF',
                                    strokeWeight: 3,
                                    scale: 10,
                                },
                                title: 'Your Location',
                                animation: google.maps.Animation.DROP
                            });

                            this.smoothPanTo(map, pos);
                            locationButton.innerHTML = '<i class="fas fa-location-arrow"></i>';
                        },
                        () => {
                            alert('Error: The Geolocation service failed.');
                            locationButton.innerHTML = '<i class="fas fa-location-arrow"></i>';
                        }
                    );
                } else {
                    alert('Error: Your browser doesn\'t support geolocation.');
                }
            });

            map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(locationButton);

            const style = document.createElement('style');
            style.textContent = `
                .location-button {
                    background-color: ${isDarkMode ? '#1F2937' : '#fff'};
                    border: 2px solid ${isDarkMode ? '#374151' : '#fff'};
                    border-radius: 50%;
                    box-shadow: 0 3px 8px rgba(0,0,0,.2);
                    color: ${isDarkMode ? '#E5E7EB' : '#666'};
                    cursor: pointer;
                    height: 44px;
                    width: 44px;
                    margin: 10px;
                    padding: 0;
                    text-align: center;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                .location-button:hover {
                    background-color: ${isDarkMode ? '#374151' : '#f8f9fa'};
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(0,0,0,.25);
                }
                .location-button i {
                    font-size: 16px;
                }
            `;
            document.head.appendChild(style);
        },

        initializeStartPointMap: function() {
            const mapElement = document.getElementById("start-point-mini-map");
            if (!mapElement) {
                console.log("Start point mini map element not found");
                return false;
            }

            try {
                const startPointMap = new google.maps.Map(mapElement, {
                    center: DEFAULT_CENTER,
                    zoom: 14,
                    mapTypeId: 'roadmap',
                    disableDefaultUI: true,
                    draggable: false,
                    scrollwheel: false,
                    disableDoubleClickZoom: true,
                    styles: getMapStyles()
                });

                // Add marker for depot with updated icon
                new google.maps.Marker({
                    position: DEFAULT_CENTER,
                    map: startPointMap,
                    icon: {
                        url: getDepotIcon(1.0),
                        scaledSize: new google.maps.Size(50, 60), // Increased size
                        anchor: new google.maps.Point(25, 56)
                    },
                    title: 'Çorlu Belediyesi (Başlangıç Noktası)'
                });

                return true;
            } catch (error) {
                console.error("Error initializing start point map:", error);
                return false;
            }
        },

        initializeDetailMap: function(routeJson) {
            const mapElement = document.getElementById("route-map");
            if (!mapElement) {
                console.log("Route map element not found");
                return false;
            }

            try {
                const routeData = JSON.parse(routeJson);
                const routeSteps = routeData.steps;
                const polyline = routeData.overviewPolyline;

                const detailMap = new google.maps.Map(mapElement, {
                    center: DEFAULT_CENTER,
                    zoom: DETAIL_ZOOM,
                    mapTypeId: 'roadmap',
                    streetViewControl: false,
                    mapTypeControl: false,
                    fullscreenControl: true,
                    styles: getMapStyles()
                });

                // Add depot marker with updated icon
                new google.maps.Marker({
                    position: DEFAULT_CENTER,
                    map: detailMap,
                    icon: {
                        url: getDepotIcon(1.2),
                        scaledSize: new google.maps.Size(60, 72), // Increased size
                        anchor: new google.maps.Point(30, 68)
                    },
                    title: 'Çorlu Belediyesi (Başlangıç/Bitiş Noktası)',
                    zIndex: 1000
                });

                if (routeSteps && routeSteps.length > 0) {
                    const bounds = new google.maps.LatLngBounds();

                    routeSteps.forEach((step, index) => {
                        if (!step.latitude || !step.longitude ||
                            !isFinite(step.latitude) || !isFinite(step.longitude)) {
                            return;
                        }

                        const position = { lat: step.latitude, lng: step.longitude };
                        bounds.extend(position);

                        const marker = new google.maps.Marker({
                            position: position,
                            map: detailMap,
                            icon: {
        url: getWasteBinIcon('Active', 70, 1, 1.4), // Using updated larger waste bin icon
        scaledSize: new google.maps.Size(50, 58), // Increased size from 45x52 to 50x58
        anchor: new google.maps.Point(25, 54), // Updated anchor point
        labelOrigin: new google.maps.Point(25, 29) // Updated label position
                            },
                            label: {
                                text: `${index + 1}`,
                                color: 'white',
                                fontSize: '14px', // Increased font size
                                fontWeight: 'bold'
                            },
                            title: step.address
                        });

                        const infoWindow = new google.maps.InfoWindow({
                            content: this.createStepInfoContent(step, index + 1)
                        });

                        marker.addListener('click', () => {
                            if (currentInfoWindow) {
                                currentInfoWindow.close();
                            }
                            infoWindow.open(detailMap, marker);
                            currentInfoWindow = infoWindow;
                        });
                    });

                    // Handle polyline
                    if (polyline) {
                        try {
                            const path = google.maps.geometry.encoding.decodePath(polyline);
                            if (path && path.length > 0) {
                                const routePolyline = new google.maps.Polyline({
                                    path: path,
                                    geodesic: true,
                                    strokeColor: '#4285F4',
                                    strokeOpacity: 0.8,
                                    strokeWeight: 4
                                });
                                routePolyline.setMap(detailMap);
                                path.forEach(point => bounds.extend(point));
                            }
                        } catch (error) {
                            console.error("Error decoding polyline:", error);
                        }
                    } else {
                        const path = routeSteps
                            .filter(step => step.latitude && step.longitude &&
                                   isFinite(step.latitude) && isFinite(step.longitude))
                            .map(step => ({ lat: step.latitude, lng: step.longitude }));

                        if (path.length > 0) {
                            path.unshift(DEFAULT_CENTER);
                            path.push(DEFAULT_CENTER);

                            const routePolyline = new google.maps.Polyline({
                                path: path,
                                geodesic: true,
                                strokeColor: '#4285F4',
                                strokeOpacity: 0.8,
                                strokeWeight: 4
                            });
                            routePolyline.setMap(detailMap);
                        }
                    }

                    if (!bounds.isEmpty()) {
                        detailMap.fitBounds(bounds);
                        google.maps.event.addListenerOnce(detailMap, 'bounds_changed', function() {
                            if (detailMap.getZoom() > 15) {
                                detailMap.setZoom(15);
                            }
                        });
                    }
                }

                this.initializeSimulation(routeData, detailMap);
                return true;
            } catch (error) {
                console.error("Error initializing detail map:", error);
                return false;
            }
        },

        initializeSimulation: function(routeData, map) {
            if (!map || !routeData || !routeData.steps || routeData.steps.length === 0) {
                return false;
            }

            try {
                simulationNotificationSent = false;
                alreadyNotifiedSteps = [];

                const steps = routeData.steps;
                const polyline = routeData.overviewPolyline;

                let path;
                if (polyline) {
                    try {
                        path = google.maps.geometry.encoding.decodePath(polyline);
                        if (!path || path.length === 0) {
                            path = null;
                        }
                    } catch (error) {
                        path = null;
                    }
                }

                if (!path || path.length === 0) {
                    path = [];
                    steps.forEach(step => {
                        if (step.latitude && step.longitude &&
                            isFinite(step.latitude) && isFinite(step.longitude)) {
                            path.push({ lat: step.latitude, lng: step.longitude });
                        }
                    });

                    if (path.length > 0) {
                        path.unshift(DEFAULT_CENTER);
                        path.push(DEFAULT_CENTER);
                    } else {
                        path = [DEFAULT_CENTER];
                    }
                }

                const truckIcon = {
                    url: getTruckIcon('#4285F4', 1.2),
                    scaledSize: new google.maps.Size(43, 52),
                    anchor: new google.maps.Point(21.5, 48)
                };

                simulationVehicleMarker = new google.maps.Marker({
                    position: path[0],
                    map: map,
                    icon: truckIcon,
                    title: 'Çöp Kamyonu',
                    zIndex: 1000
                });

                const traveledPath = new google.maps.Polyline({
                    path: [],
                    geodesic: true,
                    strokeColor: '#28a745',
                    strokeOpacity: 0.8,
                    strokeWeight: 5
                });
                traveledPath.setMap(map);

                const remainingPath = new google.maps.Polyline({
                    path: path,
                    geodesic: true,
                    strokeColor: '#3B82F6',
                    strokeOpacity: 0.8,
                    strokeWeight: 5
                });
                remainingPath.setMap(map);

                // Setup simulation controls
                this.setupSimulationControls(path, traveledPath, remainingPath, map, routeData);

                return true;
            } catch (error) {
                console.error("Error initializing simulation:", error);
                return false;
            }
        },

        setupSimulationControls: function(path, traveledPath, remainingPath, map, routeData) {
            let simulationIndex = 0;
            let simulationRunning = false;
            let simulationComplete = false;
            let simulationInterval = null;
            let simulationSpeed = 1;

            const startButton = document.getElementById('start-simulation');
            const pauseButton = document.getElementById('pause-simulation');
            const stopButton = document.getElementById('stop-simulation');
            const speedSlider = document.getElementById('speed-slider');
            const speedValue = document.getElementById('speed-value');
            const progressBar = document.getElementById('progress-bar');
            const progressPercentage = document.getElementById('progress-percentage');

            if (speedSlider) {
                speedSlider.addEventListener('input', function() {
                    simulationSpeed = parseInt(this.value);
                    if (speedValue) {
                        speedValue.textContent = simulationSpeed + 'x';
                    }
                });
            }

            function startSimulation() {
                if (simulationInterval) {
                    clearInterval(simulationInterval);
                }

                simulationInterval = setInterval(() => {
                    if (!simulationRunning) return;

                    if (simulationIndex >= path.length) {
                        clearInterval(simulationInterval);
                        simulationRunning = false;
                        simulationComplete = true;

                        if (!simulationNotificationSent) {
                            simulationNotificationSent = true;
                            if (dotNetRef) {
                                dotNetRef.invokeMethodAsync('ShowToastFromJs', '🚚 Rota simülasyonu tamamlandı!');
                            }
                        }
                        return;
                    }

                    const pos = path[simulationIndex];

                    if (simulationVehicleMarker) {
                        simulationVehicleMarker.setPosition(pos);
                    }

                    map.panTo(pos);

                    traveledPath.setPath(path.slice(0, simulationIndex + 1));
                    remainingPath.setPath(path.slice(simulationIndex));

                    if (progressBar && progressPercentage) {
                        const pct = Math.floor(simulationIndex / path.length * 100);
                        progressBar.style.width = pct + '%';
                        progressPercentage.textContent = pct + '%';
                    }

                    simulationIndex += simulationSpeed;
                }, 200);

                simulationRunning = true;
            }

            if (startButton) {
                startButton.addEventListener('click', () => {
                    if (simulationComplete) {
                        simulationIndex = 0;
                        simulationComplete = false;
                        simulationNotificationSent = false;
                        traveledPath.setPath([]);
                        remainingPath.setPath(path);

                        if (simulationVehicleMarker) {
                            simulationVehicleMarker.setPosition(path[0]);
                        }
                    }

                    simulationRunning = true;
                    startSimulation();
                });
            }

            if (pauseButton) {
                pauseButton.addEventListener('click', () => {
                    simulationRunning = false;
                });
            }

            if (stopButton) {
                stopButton.addEventListener('click', () => {
                    simulationRunning = false;
                    simulationIndex = 0;
                    simulationComplete = false;
                    simulationNotificationSent = false;

                    if (simulationVehicleMarker) {
                        simulationVehicleMarker.setPosition(path[0]);
                    }

                    traveledPath.setPath([]);
                    remainingPath.setPath(path);

                    if (progressBar && progressPercentage) {
                        progressBar.style.width = '0%';
                        progressPercentage.textContent = '0%';
                    }
                });
            }
        },

        showAllRoutes: function(routesJson, wasteBinsJson) {
            if (!mainMap) {
                console.error("Main map not initialized");
                return false;
            }

            this.clearMarkers();
            this.clearPolylines();
            this.clearWasteBinMarkers();

            try {
                const routes = JSON.parse(routesJson);
                const wasteBins = wasteBinsJson ? JSON.parse(wasteBinsJson) : null;

                console.log(`Showing ${routes.length} routes on map`);

                if (wasteBins && wasteBins.length > 0) {
                    this.showWasteBins(wasteBins);
                }

                const bounds = new google.maps.LatLngBounds();
                bounds.extend(DEFAULT_CENTER);

                const colors = ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#8E24AA', '#16A085', '#E67E22', '#E74C3C', '#2980B9', '#27AE60'];

                routes.forEach((route, routeIndex) => {
                    if (route.status === 'Completed' || route.Status === 'Completed' ||
                        route.status === 2 || route.Status === 2) return;

                    if (!route.steps || route.steps.length === 0) return;

                    const color = colors[routeIndex % colors.length];
                    let path = null;

                    if (route.overviewPolyline) {
                        try {
                            path = google.maps.geometry.encoding.decodePath(route.overviewPolyline);
                            if (!path || path.length === 0) {
                                path = null;
                            }
                        } catch (error) {
                            path = null;
                        }
                    }

                    if (!path || path.length === 0) {
                        if (route.steps && route.steps.length > 0) {
                            path = route.steps.filter(step =>
                                step.latitude && step.longitude &&
                                isFinite(step.latitude) && isFinite(step.longitude)
                            ).map(step => ({
                                lat: step.latitude,
                                lng: step.longitude
                            }));

                            if (path.length > 0) {
                                path.unshift(DEFAULT_CENTER);
                                path.push(DEFAULT_CENTER);
                            } else {
                                path = [DEFAULT_CENTER];
                            }
                        } else {
                            return;
                        }
                    }

                    try {
                        const routePolyline = new google.maps.Polyline({
                            path: path,
                            geodesic: true,
                            strokeColor: color,
                            strokeOpacity: 0.7,
                            strokeWeight: 4
                        });
                        routePolyline.setMap(mainMap);
                        routePolylines.push(routePolyline);

                        if (path && path.length > 0) {
                            const vehicleMarker = new google.maps.Marker({
                                position: path[0],
                                map: mainMap,
                                icon: {
                                    url: getTruckIcon(color, 1.0),
                                    scaledSize: new google.maps.Size(36, 43),
                                    anchor: new google.maps.Point(18, 39)
                                },
                                title: `Route ${route.id} - ${route.wasteType}`,
                                routeId: route.id,
                                routeData: route
                            });

                            truckMarkers.push(vehicleMarker);

                            vehicleMarker.addListener('click', () => {
                                this.onRouteMarkerClick(vehicleMarker, route);
                            });
                        }

                        path.forEach(point => {
                            if (point && point.lat && point.lng &&
                                isFinite(point.lat) && isFinite(point.lng)) {
                                bounds.extend(point);
                            }
                        });
                    } catch (error) {
                        console.error("Error creating polyline for route:", route.id, error);
                    }
                });

                // Add depot marker with updated icon
                const depotMarker = new google.maps.Marker({
                    position: DEFAULT_CENTER,
                    map: mainMap,
                    icon: {
                        url: getDepotIcon(1.5),
                        scaledSize: new google.maps.Size(75, 90), // Increased size
                        anchor: new google.maps.Point(37.5, 84)
                    },
                    title: 'Çorlu Belediyesi (Araç Deposu)',
                    zIndex: 1000
                });

                depotMarker.addListener('click', () => {
                    this.openDepotSidebar();
                });

                markers.push(depotMarker);

                if (bounds.isEmpty()) {
                    mainMap.setCenter(DEFAULT_CENTER);
                    mainMap.setZoom(DEFAULT_ZOOM);
                } else {
                    mainMap.fitBounds(bounds);
                    google.maps.event.addListenerOnce(mainMap, 'bounds_changed', function() {
                        if (mainMap.getZoom() > 15) {
                            mainMap.setZoom(15);
                        }
                    });
                }

                return true;
            } catch (error) {
                console.error("Error showing routes on map:", error);
                return false;
            }
        },

        onRouteMarkerClick: function(marker, route) {
            this.smoothPanTo(mainMap, marker.getPosition());

            marker.setAnimation(google.maps.Animation.BOUNCE);
            setTimeout(() => {
                marker.setAnimation(null);
            }, 1500);

            this.openRouteSidebar(route);
            selectedRouteId = route.id;

            if (dotNetRef) {
                dotNetRef.invokeMethodAsync('FocusRouteOnMap', route.id);
            }
        },

        openRouteSidebar: function(route) {
            const sidebar = document.getElementById('route-sidebar');
            if (!sidebar) {
                this.createRouteSidebar();
            }

            const sidebarElement = document.getElementById('route-sidebar');

            const getStatusColor = (status) => {
                switch (status) {
                    case 'Scheduled': return '#3B82F6';
                    case 'Active': return '#10B981';
                    case 'Completed': return '#6B7280';
                    default: return '#6B7280';
                }
            };

            const getStatusText = (status) => {
                switch (status) {
                    case 'Scheduled': return 'Planlanmış';
                    case 'Active': return 'Aktif';
                    case 'Completed': return 'Tamamlanmış';
                    default: return status;
                }
            };

            const progressPercentage = route.steps && route.steps.length > 0
                ? (route.steps.filter(s => s.isCompleted).length / route.steps.length * 100)
                : 0;

            sidebarElement.innerHTML = `
                <div class="h-full flex flex-col">
                    <div class="p-4 bg-primary-500 text-white flex justify-between items-center">
                        <h2 class="text-xl font-bold flex items-center">
                            <i class="fas fa-route mr-2"></i> Rota Detayı
                        </h2>
                        <button class="p-2 hover:bg-primary-600 rounded" onclick="googleMapsInterop.closeRouteSidebar()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="p-4 bg-white dark:bg-gray-800 shadow-md">
                        <div class="bg-${getStatusColor(route.status).includes('10B981') ? 'green' : getStatusColor(route.status).includes('3B82F6') ? 'blue' : 'gray'}-100 text-${getStatusColor(route.status).includes('10B981') ? 'green' : getStatusColor(route.status).includes('3B82F6') ? 'blue' : 'gray'}-800 dark:bg-${getStatusColor(route.status).includes('10B981') ? 'green' : getStatusColor(route.status).includes('3B82F6') ? 'blue' : 'gray'}-900/20 dark:text-${getStatusColor(route.status).includes('10B981') ? 'green' : getStatusColor(route.status).includes('3B82F6') ? 'blue' : 'gray'}-300 px-3 py-1 inline-block rounded-full text-sm font-medium mb-2">
                            ${getStatusText(route.status)}
                        </div>
                        <p class="text-gray-700 dark:text-gray-300 mb-2 flex items-start">
                            <i class="fas fa-calendar-alt text-blue-500 mr-2 mt-1"></i>
                            <span>${new Date(route.startTime).toLocaleString('tr-TR')}</span>
                        </p>
                        <p class="text-gray-700 dark:text-gray-300 mb-2 flex items-start">
                            <i class="fas fa-trash-alt text-green-500 mr-2 mt-1"></i>
                            <span>${route.wasteType}</span>
                        </p>
                    </div>

                    <div class="flex-1 overflow-y-auto p-4">
                        <!-- Rota Özeti -->
                        <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow-md transform transition-all duration-300 hover:scale-105 mb-4">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center">
                                    <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                                    Rota Bilgileri
                                </h3>
                            </div>

                            <div class="space-y-3">
                                <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-2">
                                    <span class="text-sm text-gray-500 dark:text-gray-400">Toplam Mesafe:</span>
                                    <span class="text-sm font-medium text-gray-800 dark:text-gray-200">${route.totalDistanceKm?.toFixed(1) || 0} km</span>
                                </div>
                                <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-2">
                                    <span class="text-sm text-gray-500 dark:text-gray-400">Tahmini Süre:</span>
                                    <span class="text-sm font-medium text-gray-800 dark:text-gray-200">${route.estimatedDurationMin || 0} dk</span>
                                </div>
                                <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-2">
                                    <span class="text-sm text-gray-500 dark:text-gray-400">Tahmini Yakıt:</span>
                                    <span class="text-sm font-medium text-gray-800 dark:text-gray-200">${route.estimatedFuelL?.toFixed(2) || 0} L</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-500 dark:text-gray-400">Toplam Adım:</span>
                                    <span class="text-sm font-medium text-gray-800 dark:text-gray-200">${route.steps?.length || 0} adet</span>
                                </div>
                            </div>
                        </div>

                        <!-- İlerleme Durumu -->
                        <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow-md transform transition-all duration-300 hover:scale-105 mb-4">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center">
                                    <i class="fas fa-chart-line mr-2 text-green-500"></i>
                                    İlerleme Durumu
                                </h3>
                                <button class="text-primary-500 hover:text-primary-700 px-2 py-1 rounded text-xs border border-primary-500"
                                        onclick="googleMapsInterop.showRouteDetails('${route.id}')">
                                    <i class="fas fa-info mr-1"></i> Detaylar
                                </button>
                            </div>

                            <div class="space-y-4">
                                <div class="flex justify-center">
                                    <div class="relative w-24 h-24">
                                        <svg class="w-full h-full" viewBox="0 0 36 36">
                                            <path class="stroke-current text-gray-200 dark:text-gray-700" fill="none" stroke-width="3.8" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                            <path class="stroke-current ${progressPercentage >= 100 ? 'text-green-500' : progressPercentage >= 75 ? 'text-blue-500' : progressPercentage >= 50 ? 'text-yellow-500' : 'text-red-500'}" fill="none" stroke-width="3.8" stroke-linecap="round"
                                                  stroke-dasharray="${progressPercentage}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831">
                                                <animate attributeName="stroke-dasharray"
                                                         from="0, 100"
                                                         to="${progressPercentage}, 100"
                                                         dur="1s"
                                                         fill="freeze"
                                                         calcMode="spline"
                                                         keyTimes="0; 1"
                                                         keySplines="0.42 0 0.58 1" />
                                            </path>
                                            <text x="18" y="20.5" class="fill-current font-bold text-gray-700 dark:text-gray-200" text-anchor="middle" font-size="7">${progressPercentage.toFixed(0)}%</text>
                                        </svg>
                                    </div>
                                </div>

                                <div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-2">
                                        <div class="${progressPercentage >= 100 ? 'bg-green-500' : progressPercentage >= 75 ? 'bg-blue-500' : progressPercentage >= 50 ? 'bg-yellow-500' : 'bg-red-500'} h-2.5 rounded-full transition-all duration-500" style="width: ${progressPercentage}%"></div>
                                    </div>
                                </div>

                                ${route.status !== 'Completed' ? `
                                    <button class="w-full mt-2 py-1.5 bg-green-500 hover:bg-green-600 text-white rounded-md transition-colors flex items-center justify-center"
                                            onclick="googleMapsInterop.completeRoute('${route.id}')">
                                        <i class="fas fa-check-circle mr-2"></i> Rotayı Tamamla
                                    </button>
                                ` : `
                                    <div class="w-full mt-2 py-1.5 bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 rounded-md flex items-center justify-center">
                                        <i class="fas fa-check-double mr-2"></i> Rota Tamamlandı
                                    </div>
                                `}
                            </div>
                        </div>

                        <!-- Adımlar -->
                        ${route.steps && route.steps.length > 0 ? `
                            <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow-md transform transition-all duration-300 hover:scale-105">
                                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-3 flex items-center">
                                    <i class="fas fa-list-check mr-2 text-purple-500"></i> Rota Adımları
                                </h3>

                                <div class="space-y-2 max-h-48 overflow-y-auto">
                                    ${route.steps.slice(0, 5).map((step, index) => `
                                        <div class="group flex items-center justify-between p-3 bg-white dark:bg-gray-700 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer mb-2
                                                   transition-all duration-300 ease-out hover:scale-[1.02] hover:shadow-md border border-gray-100 dark:border-gray-600 hover:border-gray-200 dark:hover:border-gray-500">
                                            <div class="flex items-center min-w-0 flex-1">
                                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-white shadow-sm transition-transform duration-300 group-hover:scale-110"
                                                     style="background: linear-gradient(135deg, ${step.isCompleted ? '#10B981' : '#F59E0B'}, ${step.isCompleted ? '#059669' : '#D97706'})">
                                                    <span class="text-xs font-bold">${index + 1}</span>
                                                </div>
                                                <div class="ml-3 min-w-0 flex-1">
                                                    <div class="font-semibold text-gray-900 dark:text-white truncate text-sm">
                                                        Adım ${index + 1}
                                                    </div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400 truncate">
                                                        ${step.address || 'Adres bilgisi yok'}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="flex items-center">
                                                <span class="${step.isCompleted ? 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300' : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-300'} px-2 py-0.5 rounded-full text-xs">
                                                    ${step.isCompleted ? 'Tamamlandı' : 'Beklemede'}
                                                </span>
                                            </div>
                                        </div>
                                    `).join('')}
                                    ${route.steps.length > 5 ? `
                                        <div class="text-center text-gray-500 dark:text-gray-400 text-sm pt-2">
                                            ve ${route.steps.length - 5} adım daha...
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            sidebarElement.classList.add('active');
            document.body.classList.add('sidebar-active');
        },

        openDepotSidebar: function() {
            const sidebar = document.getElementById('route-sidebar');
            if (!sidebar) {
                this.createRouteSidebar();
            }

            const sidebarElement = document.getElementById('route-sidebar');

            sidebarElement.innerHTML = `
                <div class="h-full flex flex-col">
                    <div class="p-4 bg-primary-500 text-white flex justify-between items-center">
                        <h2 class="text-xl font-bold flex items-center">
                            <i class="fas fa-warehouse mr-2"></i> Araç Deposu
                        </h2>
                        <button class="p-2 hover:bg-primary-600 rounded" onclick="googleMapsInterop.closeRouteSidebar()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="p-4 bg-white dark:bg-gray-800 shadow-md">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Çorlu Belediyesi</h3>
                        <p class="text-gray-700 dark:text-gray-300 mb-2 flex items-start">
                            <i class="fas fa-map-marker-alt text-red-500 mr-2 mt-1"></i>
                            <span>Merkez Araç Deposu ve Başlangıç Noktası</span>
                        </p>
                        <p class="text-gray-700 dark:text-gray-300 mb-2 flex items-start">
                            <i class="fas fa-globe text-blue-500 mr-2 mt-1"></i>
                            <span>${DEFAULT_CENTER.lat.toFixed(6)}, ${DEFAULT_CENTER.lng.toFixed(6)}</span>
                        </p>
                    </div>

                    <div class="flex-1 overflow-y-auto p-4">
                        <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow-md transform transition-all duration-300 hover:scale-105 mb-4">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center">
                                    <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                                    Depo Bilgileri
                                </h3>
                            </div>

                            <div class="space-y-3">
                                <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-2">
                                    <span class="text-sm text-gray-500 dark:text-gray-400">Tüm Rotaların Başlangıç Noktası</span>
                                    <span class="text-sm font-medium text-gray-800 dark:text-gray-200">Aktif</span>
                                </div>
                                <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-2">
                                    <span class="text-sm text-gray-500 dark:text-gray-400">Tüm Rotaların Bitiş Noktası</span>
                                    <span class="text-sm font-medium text-gray-800 dark:text-gray-200">Aktif</span>
                                </div>
                                <div class="flex justify-between items-center border-b border-gray-200 dark:border-gray-700 pb-2">
                                    <span class="text-sm text-gray-500 dark:text-gray-400">Koordinat:</span>
                                    <span class="text-sm font-medium text-gray-800 dark:text-gray-200">${DEFAULT_CENTER.lat.toFixed(4)}, ${DEFAULT_CENTER.lng.toFixed(4)}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-500 dark:text-gray-400">Durum:</span>
                                    <span class="text-sm font-medium text-green-600 dark:text-green-400">Operasyonel</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow-md transform transition-all duration-300 hover:scale-105">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-3 flex items-center">
                                <i class="fas fa-route mr-2 text-green-500"></i> Operasyon Merkezi
                            </h3>
                            <p class="text-gray-600 dark:text-gray-400 text-sm">
                                Bu konum tüm atık toplama rotalarının başlangıç ve bitiş noktasıdır.
                                Araçlar buradan yola çıkar ve görevlerini tamamladıktan sonra buraya geri döner.
                            </p>
                        </div>
                    </div>
                </div>
            `;

            sidebarElement.classList.add('active');
            document.body.classList.add('sidebar-active');
        },

        createRouteSidebar: function() {
            const sidebar = document.createElement('div');
            sidebar.id = 'route-sidebar';
            sidebar.className = 'fixed top-0 right-[-400px] h-full w-[400px] bg-white dark:bg-gray-800 shadow-lg z-50 overflow-y-auto transition-all duration-300 ease-in-out border-l-4 border-primary-500';

            const style = document.createElement('style');
            style.textContent = `
                #route-sidebar.active {
                    right: 0;
                }
                .sidebar-active #admin-observer-map {
                    width: calc(100% - 400px);
                    transition: width 0.4s ease;
                }
            `;
            document.head.appendChild(style);

            document.body.appendChild(sidebar);
        },

        closeRouteSidebar: function() {
            const sidebar = document.getElementById('route-sidebar');
            if (sidebar) {
                sidebar.classList.remove('active');
                document.body.classList.remove('sidebar-active');
            }
        },

        showWasteBins: function(wasteBins) {
            if (!mainMap || !wasteBins || wasteBins.length === 0) return false;

            const markers = [];
            wasteBins.forEach(bin => {
                if (bin.latitude && bin.longitude &&
                    isFinite(bin.latitude) && isFinite(bin.longitude)) {
                    const position = { lat: bin.latitude, lng: bin.longitude };

                    const marker = new google.maps.Marker({
                        position: position,
                        icon: {
                            url: getWasteBinIcon(bin.deviceStatus || 'Active', bin.fillLevel || 0, 0.8, 1.0), // Increased scale
                    scaledSize: new google.maps.Size(40, 46), // Increased size from 32x37 to 40x46
                    anchor: new google.maps.Point(20, 44) // Updated anchor point
                        },
                        title: `${bin.label} - ${bin.fillLevel || 0}% dolu`,
                        opacity: 0.8
                    });

                    const infoWindow = new google.maps.InfoWindow({
                        content: this.createBinInfoContent(bin)
                    });

                    marker.addListener('click', () => {
                        if (currentInfoWindow) {
                            currentInfoWindow.close();
                        }
                        infoWindow.open(mainMap, marker);
                        currentInfoWindow = infoWindow;
                    });

                    markers.push(marker);
                    wasteBinMarkers.push(marker);
                }
            });

            // Create marker clusterer
            this.createMarkerClusterer(markers);
            return true;
        },

        createMarkerClusterer: function(markers) {
            try {
                if (markerCluster) {
                    markerCluster.clearMarkers();
                    markerCluster = null;
                }

                if (markers.length > 0) {
                    const clusterStyles = [
                        {
                            textColor: 'white',
                            url: this.createClusterIcon(35, RECYCLING_GREEN),
                            height: 35,
                            width: 35,
                            textSize: 11
                        },
                        {
                            textColor: 'white',
                            url: this.createClusterIcon(45, '#F59E0B'),
                            height: 45,
                            width: 45,
                            textSize: 13
                        },
                        {
                            textColor: 'white',
                            url: this.createClusterIcon(55, '#EF4444'),
                            height: 55,
                            width: 55,
                            textSize: 15
                        }
                    ];

                    if (window.markerClusterer && window.markerClusterer.MarkerClusterer) {
                        markerCluster = new window.markerClusterer.MarkerClusterer({
                            map: mainMap,
                            markers: markers
                        });
                    } else if (window.MarkerClusterer) {
                        markerCluster = new window.MarkerClusterer(mainMap, markers, {
                            styles: clusterStyles
                        });
                    } else {
                        markers.forEach(marker => marker.setMap(mainMap));
                    }
                }
            } catch (error) {
                console.warn("Error creating marker clusterer:", error);
                markers.forEach(marker => marker.setMap(mainMap));
            }
        },

        createClusterIcon: function(size, color) {
            const svg = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${size} ${size}" width="${size}" height="${size}">
                    <defs>
                        <filter id="shadow-${size}" x="-50%" y="-50%" width="200%" height="200%">
                            <feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity="0.3"/>
                        </filter>
                        <radialGradient id="grad-${size}" cx="30%" cy="30%" r="70%">
                            <stop offset="0%" style="stop-color:${color};stop-opacity:1" />
                            <stop offset="100%" style="stop-color:${this.darkenColor(color, 20)};stop-opacity:1" />
                        </radialGradient>
                    </defs>
                    <circle cx="${size/2}" cy="${size/2}" r="${size/2-2}"
                            fill="url(#grad-${size})"
                            stroke="white"
                            stroke-width="3"
                            opacity="0.95"
                            filter="url(#shadow-${size})"/>
                </svg>
            `;
            return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
        },

        darkenColor: function(color, percent) {
            const hex = color.replace('#', '');
            const num = parseInt(hex, 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.max(0, Math.min(255, (num >> 16) - amt));
            const G = Math.max(0, Math.min(255, (num >> 8 & 0x00FF) - amt));
            const B = Math.max(0, Math.min(255, (num & 0x0000FF) - amt));
            return "#" + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
        },

        createBinInfoContent: function(bin) {
            const getFillLevelColor = (level) => {
                if (!level) return '#6B7280';
                if (level >= 90) return '#EF4444';
                if (level >= 70) return '#F97316';
                if (level >= 50) return '#F59E0B';
                return '#10B981';
            };

            return `
                <div style="padding: 12px; max-width: 280px; font-family: Arial, sans-serif;">
                    <div style="font-weight: bold; font-size: 16px; margin-bottom: 8px; color: #1F2937;">
                        ${bin.label}
                    </div>
                    <div style="margin-bottom: 6px; font-size: 14px; color: #6B7280;">
                        ${bin.address}
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <span style="margin-right: 8px; font-size: 14px; color: #6B7280;">Doluluk:</span>
                        <span style="font-weight: bold; color: ${getFillLevelColor(bin.fillLevel)};">
                            ${bin.fillLevel || 0}%
                        </span>
                    </div>
                    <div style="width: 100%; height: 8px; background-color: #E5E7EB; border-radius: 4px; overflow: hidden;">
                        <div style="height: 100%; background-color: ${getFillLevelColor(bin.fillLevel)}; width: ${bin.fillLevel || 0}%; transition: width 0.3s ease;"></div>
                    </div>
                </div>
            `;
        },

        createStepInfoContent: function(step, stepNumber) {
            return `
                <div style="padding: 12px; max-width: 280px; font-family: Arial, sans-serif;">
                    <div style="font-weight: bold; font-size: 16px; margin-bottom: 8px; color: #1F2937; border-bottom: 1px solid #E5E7EB; padding-bottom: 4px;">
                        Adım ${stepNumber}
                    </div>
                    <div style="margin-bottom: 6px; font-size: 14px; color: #6B7280;">
                        ${step.address}
                    </div>
                    <div style="font-size: 12px; color: #9CA3AF; margin-bottom: 8px;">
                        ${step.latitude.toFixed(6)}, ${step.longitude.toFixed(6)}
                    </div>
                    <div style="font-weight: bold; color: ${step.isCompleted ? '#10B981' : '#F59E0B'};">
                        ${step.isCompleted ? '✓ Tamamlandı' : '⏳ Beklemede'}
                    </div>
                </div>
            `;
        },

        smoothPanTo: function (map, position) {
            if (!position || !isFinite(position.lat) || !isFinite(position.lng)) {
                console.error("Invalid coordinates for smoothPanTo:", position);
                return;
            }

            const currentCenter = map.getCenter();
            const currentLat = currentCenter.lat();
            const currentLng = currentCenter.lng();
            const targetLat = position.lat;
            const targetLng = position.lng;

            const frames = 60;
            let frame = 0;

            const animate = () => {
                if (frame >= frames) {
                    try {
                        map.panTo(position);
                    } catch (e) {
                        console.error("Error in final panTo:", e);
                    }
                    return;
                }

                const t = frame / frames;
                const progress = t < 0.5 ?
                    4 * t * t * t :
                    1 - Math.pow(-2 * t + 2, 3) / 2;

                const lat = currentLat + (targetLat - currentLat) * progress;
                const lng = currentLng + (targetLng - currentLng) * progress;

                try {
                    map.panTo({ lat, lng });
                } catch (e) {
                    console.error("Error during animation panTo:", e);
                    return;
                }

                frame++;
                requestAnimationFrame(animate);
            };

            animate();
        },

        focusRouteOnMap: function(routeId) {
            const marker = truckMarkers.find(m => m.routeId === routeId);
            if (!marker) return false;

            try {
                const position = marker.getPosition();
                mainMap.setCenter(position);
                mainMap.setZoom(FOCUS_ZOOM);

                google.maps.event.trigger(marker, 'click');

                marker.setAnimation(google.maps.Animation.BOUNCE);
                setTimeout(() => {
                    marker.setAnimation(null);
                }, 1500);

                return true;
            } catch (error) {
                console.error("Error focusing route on map:", error);
                return false;
            }
        },

        clearMarkers: function() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            truckMarkers.forEach(marker => marker.setMap(null));
            truckMarkers = [];
        },

        clearPolylines: function() {
            routePolylines.forEach(polyline => polyline.setMap(null));
            routePolylines = [];
        },

        clearWasteBinMarkers: function() {
            if (markerCluster) {
                markerCluster.clearMarkers();
                markerCluster = null;
            }
            wasteBinMarkers.forEach(marker => marker.setMap(null));
            wasteBinMarkers = [];
        },

        resetMapState: function() {
            console.log("Resetting map state");
            if (currentInfoWindow) {
                currentInfoWindow.close();
                currentInfoWindow = null;
            }

            this.closeRouteSidebar();
            selectedRouteId = null;

            if (simulationVehicleMarker) {
                simulationVehicleMarker.setMap(null);
                simulationVehicleMarker = null;
            }
        },

        // Add disposeResources method for cleanup
        disposeResources: function() {
            this.clearMarkers();
            this.clearPolylines();
            this.clearWasteBinMarkers();
            this.resetMapState();
        },

        // Blazor interop methods
        showRouteDetails: function(routeId) {
            if (dotNetRef) {
                dotNetRef.invokeMethodAsync('ShowDetails', routeId);
            }
        },

        completeRoute: function(routeId) {
            if (dotNetRef) {
                dotNetRef.invokeMethodAsync('CompleteRoute', routeId);
            }
        }
    };
</script>
@code {
    // Data
    private List<RouteResultDto> routes;
    private List<RouteResultDto> filteredRoutes = new List<RouteResultDto>();
    private List<RouteResultDto> displayedRoutes => GetDisplayedRoutes();
    private List<ResultVehicleDto> vehicles;
    private List<ResultUserDto> drivers;
    private List<ResultUserDto> availableDrivers => GetAvailableDrivers(); // New property for available drivers
    private List<ResultVehicleDto> availableVehicles => GetAvailableVehicles(); // New property for available vehicles
    private List<ResultWasteBinDto> wasteBins;
    private List<ResultWasteBinDto> filteredBins = new List<ResultWasteBinDto>();

    // Selected items
    private RouteResultDto selectedRoute;
    private CreateRouteDto newRoute = new CreateRouteDto();

    // UI state flags
    private bool isModalOpen = false;
    private bool showCreateModal = false;
    private bool mainMapInitialized = false;
    private Guid expandedRouteId;
    private DotNetObjectReference<RoutesManager> _objectReference;
    private CancellationTokenSource _debounceTokenSource = new CancellationTokenSource();

    // Filters
    private string driverFilter = "";
    private RouteStatus? statusFilter;
    private DateTime? startDateFilter;
    private DateTime? endDateFilter;
    private string searchText = "";
    private string binSearchText = "";

    // Pagination
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages => filteredRoutes == null ? 0 : (int)Math.Ceiling(filteredRoutes.Count / (double)pageSize);
    private int startPage => Math.Max(1, currentPage - 2);
    private int endPage => Math.Min(totalPages, startPage + 4);

    // Sorting
    private string sortField = "StartTime";
    private bool sortAscending = false;

    // Fixed start/end point (Çorlu Belediyesi)
    private double fixedStartLat = 41.1634;
    private double fixedStartLng = 27.7951;

    private static readonly JsonSerializerOptions camelCase =
    new() { PropertyNamingPolicy = JsonNamingPolicy.CamelCase };

    // New methods to filter out drivers and vehicles that are already assigned to active routes
    private List<ResultUserDto> GetAvailableDrivers()
    {
        if (drivers == null || routes == null)
            return new List<ResultUserDto>();

        // Get IDs of drivers with active routes (not completed)
        var busyDriverIds = routes
            .Where(r => r.Status != RouteStatus.Completed)
            .Select(r => r.DriverId)
            .ToHashSet();

        // Return only drivers who are not busy
        return drivers.Where(d => !busyDriverIds.Contains(d.Id)).ToList();
    }

    private List<ResultVehicleDto> GetAvailableVehicles()
    {
        if (vehicles == null || routes == null)
            return new List<ResultVehicleDto>();

        // Get IDs of vehicles with active routes (not completed)
        var busyVehicleIds = routes
            .Where(r => r.Status != RouteStatus.Completed)
            .Select(r => r.VehicleId)
            .ToHashSet();

        // Return only vehicles that are not busy
        return vehicles.Where(v => !busyVehicleIds.Contains(v.Id.ToString())).ToList();
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _objectReference = DotNetObjectReference.Create(this);

            await LoadData();
            await LoadDrivers();
            await LoadVehicles();
            await LoadWasteBins();

            // Filtreleme işlemlerinden önce null kontrolü
            if (routes == null)
                routes = new List<RouteResultDto>();

            if (filteredRoutes == null)
                filteredRoutes = new List<RouteResultDto>();

            // Set default values for new route
            // Using current time + 1 hour instead of fixed 8:00 AM
            newRoute.ScheduledStart = DateTime.Now.AddHours(1);
            newRoute.StartLatitude = fixedStartLat;
            newRoute.StartLongitude = fixedStartLng;
            newRoute.EndLatitude = fixedStartLat;
            newRoute.EndLongitude = fixedStartLng;
            newRoute.WasteBinIds = new List<Guid>();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error in OnInitializedAsync: {ex.Message}");
            toastService.ShowError("Sayfa yüklenirken bir hata oluştu");
        }
    }

    public async ValueTask DisposeAsync()
    {
        await CleanupResources();
        _objectReference?.Dispose();
    }

    private async Task CleanupResources()
    {
        try
        {
            await JS.InvokeVoidAsync("googleMapsInterop.resetMapState");
            await JS.InvokeVoidAsync("googleMapsInterop.disposeResources");
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Cleanup error: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        try
        {
            if (firstRender)
            {
                await Task.Delay(500);

                await JS.InvokeVoidAsync("initializeGoogleMaps", DotNetObjectReference.Create(this));

                // Only initialize main map if data is loaded
                if (routes != null && filteredRoutes != null)
                {
                    await InitializeMainMap();
                }
            }
            else if (!mainMapInitialized && routes != null && filteredRoutes != null)
            {
                // Try to initialize map when data becomes available in subsequent renders
                await InitializeMainMap();
            }

            // Handle detail map initialization for route details
            if (isModalOpen && selectedRoute != null)
            {
                await InitializeDetailMap();
            }

            // Handle start point map initialization for create route modal
            if (showCreateModal)
            {
                await JS.InvokeVoidAsync("googleMapsInterop.initializeStartPointMap");
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error in OnAfterRenderAsync: {ex.Message}");
            toastService.ShowError("Harita yüklenirken bir hata oluştu: " + ex.Message);
        }
    }

    private async Task InitializeMainMap()
    {
        try
        {
            // The JS function now returns a boolean indicating success or failure
            var result = await JS.InvokeAsync<bool>("googleMapsInterop.initializeMainMap");

            if (result)
            {
                mainMapInitialized = true;
                // Only show routes if initialization succeeded
                await ShowAllRoutesOnMap();
            }
            else
            {
                // JS function already showed a toast, but we can handle it here as well
                mainMapInitialized = false;
                Console.Error.WriteLine("Map initialization failed");
            }
        }
        catch (Exception ex)
        {
            mainMapInitialized = false;
            Console.Error.WriteLine($"Error initializing main map: {ex.Message}");
            toastService.ShowError("Harita yüklenirken bir hata oluştu");
        }
    }

    private async Task InitializeDetailMap()
    {
        if (selectedRoute != null)
        {
            try
            {
                Console.WriteLine($"Initializing detail map for route {selectedRoute.Id} with {selectedRoute.Steps?.Count ?? 0} steps");

                var routeJson = JsonSerializer.Serialize(selectedRoute, camelCase);
                await JS.InvokeVoidAsync("googleMapsInterop.initializeDetailMap", routeJson);
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Error initializing detail map: {ex.Message}");
                toastService.ShowError("Detay haritası yüklenirken bir hata oluştu");
            }
        }
    }

    private async Task LoadData()
    {
        try
        {
            routes = await RouteService.GetAllRoutesAsync();
            ApplyFilters();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading routes: {ex.Message}");
            toastService.ShowError("Rotalar yüklenirken bir hata oluştu");
        }
    }

    private async Task LoadDrivers()
    {
        try
        {
            var authState = await AuthProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity.IsAuthenticated)
            {
                var allUsers = await UserService.GetAllUsersAsync();
                drivers = allUsers.Where(u => u.Roles.Contains("Driver")).ToList();
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading drivers: {ex.Message}");
            toastService.ShowError("Sürücüler yüklenirken bir hata oluştu");
        }
    }

    private async Task LoadVehicles()
    {
        try
        {
            vehicles = await VehicleService.GetAllVehiclesAsync();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading vehicles: {ex.Message}");
            toastService.ShowError("Araçlar yüklenirken bir hata oluştu");
        }
    }

    private async Task LoadWasteBins()
    {
        try
        {
            wasteBins = await WasteBinService.GetAllWasteBinsAsync();
            filteredBins = wasteBins.ToList();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading waste bins: {ex.Message}");
            toastService.ShowError("Atık kutuları yüklenirken bir hata oluştu");
        }
    }

    private List<RouteResultDto> GetDisplayedRoutes()
    {
        if (filteredRoutes == null) return new List<RouteResultDto>();

        return filteredRoutes
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    private void ApplyFilters()
    {
        if (routes == null)
        {
            filteredRoutes = new List<RouteResultDto>();
            return;
        }

        var query = routes.AsEnumerable();

        // Apply driver filter
        if (!string.IsNullOrEmpty(driverFilter))
        {
            query = query.Where(r => r.DriverId == driverFilter);
        }

        // Apply status filter
        if (statusFilter.HasValue)
        {
            query = query.Where(r => r.Status == statusFilter);
        }

        // Apply date range filter
        if (startDateFilter.HasValue)
        {
            query = query.Where(r => r.StartTime.Date >= startDateFilter.Value.Date);
        }

        if (endDateFilter.HasValue)
        {
            query = query.Where(r => r.StartTime.Date <= endDateFilter.Value.Date);
        }

        // Apply search text
        if (!string.IsNullOrEmpty(searchText))
        {
            var search = searchText.ToLower();
            query = query.Where(r =>
                (GetDriverName(r.DriverId)?.ToLower().Contains(search) == true) ||
                (GetVehiclePlate(r.VehicleId)?.ToLower().Contains(search) == true) ||
                (r.WasteType.ToString().ToLower().Contains(search) == true));
        }

        // Apply sorting
        query = ApplySorting(query);

        filteredRoutes = query.ToList();

        // Reset pagination if needed
        if (currentPage > 1 && (currentPage - 1) * pageSize >= filteredRoutes.Count)
        {
            currentPage = 1;
        }
    }

    private async Task ApplyFiltersWithDebounce()
    {
        try
        {
            // Önceki debounce işlemini iptal et
            _debounceTokenSource.Cancel();
            _debounceTokenSource = new CancellationTokenSource();

            // 250ms bekle
            await Task.Delay(250, _debounceTokenSource.Token);

            // Filtreleme işlemini yap
            ApplyFilters();

            // UI'ı güncelle
            StateHasChanged();
        }
        catch (TaskCanceledException)
        {
            // Debounce tarafından iptal edildi, normal durum
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Filter error: {ex.Message}");
        }
    }

    private IEnumerable<RouteResultDto> ApplySorting(IEnumerable<RouteResultDto> query)
    {
        switch (sortField)
        {
            case "StartTime":
                return sortAscending ? query.OrderBy(r => r.StartTime) : query.OrderByDescending(r => r.StartTime);
            case "Driver":
                return sortAscending ? query.OrderBy(r => GetDriverName(r.DriverId)) : query.OrderByDescending(r => GetDriverName(r.DriverId));
            case "Vehicle":
                return sortAscending ? query.OrderBy(r => GetVehiclePlate(r.VehicleId)) : query.OrderByDescending(r => GetVehiclePlate(r.VehicleId));
            case "Status":
                return sortAscending ? query.OrderBy(r => r.Status) : query.OrderByDescending(r => r.Status);
            case "Distance":
                return sortAscending ? query.OrderBy(r => r.TotalDistanceKm) : query.OrderByDescending(r => r.TotalDistanceKm);
            case "Duration":
                return sortAscending ? query.OrderBy(r => r.EstimatedDurationMin) : query.OrderByDescending(r => r.EstimatedDurationMin);
            default:
                return query;
        }
    }

    private void FilterBins()
    {
        if (wasteBins == null)
        {
            filteredBins = new List<ResultWasteBinDto>();
            return;
        }

        var query = wasteBins.AsEnumerable();

        // Apply search filter
        if (!string.IsNullOrEmpty(binSearchText))
        {
            var search = binSearchText.ToLower();
            query = query.Where(b =>
                (b.Label?.ToLower().Contains(search) == true) ||
                (b.Address?.ToLower().Contains(search) == true));
        }

        filteredBins = query.ToList();
    }

    private async Task FilterBinsWithDebounce()
    {
        try
        {
            // Önceki debounce işlemini iptal et
            _debounceTokenSource.Cancel();
            _debounceTokenSource = new CancellationTokenSource();

            // 250ms bekle
            await Task.Delay(250, _debounceTokenSource.Token);

            // Filtreleme işlemini yap
            FilterBins();

            // UI'ı güncelle
            StateHasChanged();
        }
        catch (TaskCanceledException)
        {
            // Debounce tarafından iptal edildi, normal durum
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Filter error: {ex.Message}");
        }
    }

    private async Task ShowAllRoutesOnMap()
    {
        if (routes == null || !routes.Any())
        {
            await LoadData();
        }

        if (routes != null && routes.Any())
        {
            try
            {
                // Convert route data to JSON
                var routesJson = JsonSerializer.Serialize(routes, camelCase);

                // Get waste bins for the map
                var wasteBinsJson = "";
                if (wasteBins != null && wasteBins.Any())
                {
                    wasteBinsJson = JsonSerializer.Serialize(wasteBins, camelCase);
                }

                // Show routes on the map
                await JS.InvokeVoidAsync("googleMapsInterop.showAllRoutes", routesJson, wasteBinsJson);
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Error showing routes on map: {ex}");
                toastService.ShowError("Rotalar haritada gösterilemedi");
            }
        }
    }

    private void SortTable(string field)
    {
        // Close expanded row before sorting
        expandedRouteId = Guid.Empty;

        if (sortField == field)
        {
            sortAscending = !sortAscending;
        }
        else
        {
            sortField = field;
            sortAscending = true;
        }

        ApplyFilters();
    }

    private void ChangePage(int page)
    {
        currentPage = page;
        expandedRouteId = Guid.Empty; // Close expanded row when changing page
    }

    private async Task ClearFilters()
    {
        driverFilter = "";
        statusFilter = null;
        startDateFilter = null;
        endDateFilter = null;
        searchText = "";

        ApplyFilters();
        await ShowAllRoutesOnMap();
    }

    private void ToggleExpand(Guid routeId)
    {
        if (expandedRouteId == routeId)
        {
            expandedRouteId = Guid.Empty;
        }
        else
        {
            expandedRouteId = routeId;
        }
    }

    private async Task ShowDetails(RouteResultDto route)
    {
        Console.WriteLine($"ShowDetails called for route {route.Id} with {route.Steps?.Count ?? 0} steps");

        // Check if the route has steps
        if (route.Steps == null || !route.Steps.Any())
        {
            Console.Error.WriteLine($"Warning: Route {route.Id} has no steps!");

            // Try to reload the route directly from the API
            try
            {
                var refreshedRoute = await RouteService.GetRouteByIdAsync(route.Id);
                if (refreshedRoute?.Steps != null && refreshedRoute.Steps.Any())
                {
                    route = refreshedRoute;
                    Console.WriteLine($"Successfully refreshed route with {route.Steps.Count} steps");
                }
                else
                {
                    toastService.ShowWarning("Rota detayları görüntülenemiyor: Adım bilgisi eksik.");
                }
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Error refreshing route details: {ex.Message}");
                toastService.ShowWarning("Rota detayları yüklenirken hata oluştu.");
            }
        }

        selectedRoute = route;
        isModalOpen = true;
        StateHasChanged();

        await Task.Delay(100);

        // Initialize detail map only if we have steps
        if (route.Steps != null && route.Steps.Any())
        {
            await InitializeDetailMap();
            await JS.InvokeVoidAsync("scrollToRouteMap");
        }
        else
        {
            // Show empty map with just the depot if no steps
            var emptyRoute = new RouteResultDto
                {
                    Id = route.Id,
                    DriverId = route.DriverId,
                    VehicleId = route.VehicleId,
                    WasteType = route.WasteType,
                    Steps = new List<RouteStepDto>()
                };

            var routeJson = JsonSerializer.Serialize(emptyRoute, camelCase);
            await JS.InvokeVoidAsync("googleMapsInterop.initializeDetailMap", routeJson);

            // Show a message in the map area
            await JS.InvokeVoidAsync("googleMapsInterop.showNoStepsMessage");
        }
    }

    private void ToggleBin(Guid binId, object isChecked)
    {
        if ((bool)isChecked)
        {
            if (!newRoute.WasteBinIds.Contains(binId))
            {
                newRoute.WasteBinIds.Add(binId);
            }
        }
        else
        {
            newRoute.WasteBinIds.Remove(binId);
        }
    }

    private async Task CreateRoute()
    {
        if (newRoute.WasteBinIds.Count == 0)
        {
            toastService.ShowWarning("En az bir atık kutusu seçmelisiniz");
            return;
        }

        if (string.IsNullOrEmpty(newRoute.DriverId))
        {
            toastService.ShowWarning("Bir sürücü seçmelisiniz");
            return;
        }

        if (string.IsNullOrEmpty(newRoute.VehicleId))
        {
            toastService.ShowWarning("Bir araç seçmelisiniz");
            return;
        }

        try
        {
            // Convert to API model
            var apiRoute = new ApiCreateRouteDto
                {
                    DriverId = newRoute.DriverId.ToString(),
                    VehicleId = newRoute.VehicleId.ToString(),
                    WasteType = newRoute.WasteType,
                    OptimizationType = newRoute.OptimizationType,
                    StartTime = newRoute.ScheduledStart,
                    WasteBinIds = newRoute.WasteBinIds,
                    Notes = newRoute.Notes,
                    RouteName = newRoute.RouteName,
                };

            var success = await RouteService.CreateRouteAsync(apiRoute);

            if (success)
            {
                toastService.ShowSuccess("Rota başarıyla oluşturuldu");
                showCreateModal = false;
                await LoadData();
                await ShowAllRoutesOnMap();
            }
            else
            {
                toastService.ShowError("Rota oluşturulurken bir hata oluştu");
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error creating route: {ex.Message}");
            toastService.ShowError($"Hata: {ex.Message}");
        }
    }

    private async Task CompleteRoute(Guid routeId)
    {
        try
        {
            var result = await RouteService.CompleteRouteAsync(routeId);
            if (result)
            {
                toastService.ShowSuccess("Rota başarıyla tamamlandı");
                await LoadData();
                await ShowAllRoutesOnMap();
            }
            else
            {
                toastService.ShowError("Rota tamamlanırken bir hata oluştu");
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error completing route: {ex.Message}");
            toastService.ShowError($"Hata: {ex.Message}");
        }
    }

    private async Task ReoptimizeWithTraffic(Guid routeId)
    {
        try
        {
            // Close modal first
            CloseModal();

            // Show notification
            toastService.ShowInfo("Rota trafik durumuna göre yeniden optimize ediliyor...");

            // Create a cancellation token to handle timeouts
            using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(30));

            try
            {
                // Reoptimize and get the updated route directly
                var updatedRoute = await RouteService.ReoptimizeRouteWithTrafficAsync(routeId);

                // Check if steps are present in the returned route
                if (updatedRoute?.Steps == null || !updatedRoute.Steps.Any())
                {
                    Console.Error.WriteLine($"Reoptimized route has no steps: {routeId}");
                    toastService.ShowWarning("Rota optimize edildi ancak adımlar yüklenemedi. Lütfen sayfayı yenileyin.");

                    // Try to get the route directly again after a small delay
                    await Task.Delay(500);
                    updatedRoute = await RouteService.GetRouteByIdAsync(routeId);
                }

                // Reload routes data for the list view
                await LoadData();
                await ShowAllRoutesOnMap();

                // Find and focus the route on the map
                await FocusRouteOnMap(routeId);

                // Show success message
                toastService.ShowSuccess("Rota trafik durumuna göre yeniden optimize edildi");

                // If we have a valid route with steps, show it
                if (updatedRoute?.Steps != null && updatedRoute.Steps.Any())
                {
                    Console.WriteLine($"Displaying updated route with {updatedRoute.Steps.Count} steps");
                    await Task.Delay(300); // Small delay for UI update
                    await ShowDetails(updatedRoute);
                }
                else
                {
                    // Fall back to loaded data if direct fetch failed
                    var loadedRoute = routes?.FirstOrDefault(r => r.Id == routeId);
                    if (loadedRoute?.Steps != null && loadedRoute.Steps.Any())
                    {
                        Console.WriteLine($"Displaying loaded route with {loadedRoute.Steps.Count} steps");
                        await Task.Delay(300);
                        await ShowDetails(loadedRoute);
                    }
                    else
                    {
                        toastService.ShowWarning("Rota adımları yüklenemedi. Lütfen sayfayı yenileyin.");
                    }
                }
            }
            catch (OperationCanceledException)
            {
                Console.Error.WriteLine("Route reoptimization timed out");
                toastService.ShowError("Rota optimizasyon işlemi zaman aşımına uğradı.");
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error reoptimizing route: {ex.Message}");
            toastService.ShowError($"Rota optimize edilemedi: {ex.Message}");
        }
    }

    private async Task FocusRouteOnMap(Guid routeId)
    {
        await JS.InvokeVoidAsync("googleMapsInterop.focusRouteOnMap", routeId);
    }

    // Helper methods for UI
    private string GetDriverName(string driverId)
    {
        if (string.IsNullOrEmpty(driverId) || drivers == null)
            return "Bilinmeyen Sürücü";

        var driver = drivers.FirstOrDefault(d => d.Id == driverId);
        return driver != null ? $"{driver.Name} {driver.Surname}" : "Bilinmeyen Sürücü";
    }

    private string GetVehiclePlate(string vehicleId)
    {
        if (string.IsNullOrEmpty(vehicleId) || vehicles == null)
            return "Bilinmeyen Araç";

        if (Guid.TryParse(vehicleId, out Guid vId))
        {
            var vehicle = vehicles.FirstOrDefault(v => v.Id == vId);
            return vehicle != null ? vehicle.Plate : "Bilinmeyen Araç";
        }

        return "Bilinmeyen Araç";
    }

    private string GetStatusText(RouteStatus status)
    {
        return status switch
        {
            RouteStatus.Scheduled => "Planlanmış",
            RouteStatus.Active => "Aktif",
            RouteStatus.Completed => "Tamamlanmış",
            _ => status.ToString()
        };
    }

    private string GetStatusBadgeClass(RouteStatus status)
    {
        return status switch
        {
            RouteStatus.Scheduled => "bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-300",
            RouteStatus.Active => "bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300",
            RouteStatus.Completed => "bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-300",
            _ => "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"
        };
    }

    private string GetOptimizationTypeText(OptimizationType type)
    {
        return type switch
        {
            OptimizationType.EnKisaMesafe => "En Kısa Mesafe",
            OptimizationType.DolulukOncelikli => "Doluluk Öncelikli",
            _ => type.ToString()
        };
    }
    public string GetWasteTypeText(WasteType type)
    {
        return type switch
        {
            WasteType.Cop => "Çöp",
            WasteType.GeriDonusum => "Geri Dönüşüm",
            WasteType.Organik => "Organik Atık",
            WasteType.Cam => "Cam",
            WasteType.Metal => "Metal",
            WasteType.Elektronik => "Elektronik Atık",
            WasteType.Tehlikeli => "Tehlikeli Atık",
            _ => type.ToString()
        };
    }
    private string GetProgressColor(double percentage)
    {
        return percentage switch
        {
            >= 100 => "text-green-500",
            >= 75 => "text-blue-500",
            >= 50 => "text-yellow-500",
            >= 25 => "text-orange-500",
            _ => "text-red-500"
        };
    }

    private string GetFillLevelBadgeClass(double? fillLevel)
    {
        if (!fillLevel.HasValue) return "bg-gray-100 text-gray-800";

        return fillLevel switch
        {
            >= 90 => "bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400",
            >= 70 => "bg-orange-100 text-orange-800 dark:bg-orange-900/20 dark:text-orange-400",
            >= 50 => "bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400",
            _ => "bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400"
        };
    }

    private string FormatDateTime(DateTime dateTime)
    {
        return dateTime.ToString("dd.MM.yyyy HH:mm");
    }

    // JavaScript interop methods
    [JSInvokable]
    public void OnMapInitialized()
    {
        Console.WriteLine("Map initialized from JS");
    }

    [JSInvokable]
    public string GetDriverNameFromJs(string driverId)
    {
        return GetDriverName(driverId);
    }

    [JSInvokable]
    public string GetVehiclePlateFromJs(string vehicleId)
    {
        return GetVehiclePlate(vehicleId);
    }

    [JSInvokable]
    public void ShowToastFromJs(string message)
    {
        toastService.ShowInfo(message);
    }

    [JSInvokable]
    public void CloseModal()
    {
        isModalOpen = false;
        selectedRoute = null;
        StateHasChanged();
    }

    [JSInvokable]
    public void CloseCreateModal()
    {
        showCreateModal = false;
        StateHasChanged();
    }

    [JSInvokable]
    public async Task RefreshData()
    {
        expandedRouteId = Guid.Empty;
        await LoadData();
        await ShowAllRoutesOnMap();
        toastService.ShowSuccess("Veriler yenilendi");
        StateHasChanged();
    }

    [JSInvokable]
    public void OpenCreateModal()
    {
        newRoute = new CreateRouteDto
            {
                ScheduledStart = DateTime.Now,
                StartLatitude = fixedStartLat,
                StartLongitude = fixedStartLng,
                EndLatitude = fixedStartLat,
                EndLongitude = fixedStartLng,
                OptimizationType = OptimizationType.EnKisaMesafe,
                WasteType = WasteType.GeriDonusum,
                WasteBinIds = new List<Guid>(),
                AutoOptimize = true
            };

        showCreateModal = true;
        StateHasChanged();
    }

    [JSInvokable]
    public async Task FocusRouteOnMap(string routeId)
    {
        if (Guid.TryParse(routeId, out Guid id))
        {
            var route = routes?.FirstOrDefault(r => r.Id == id);
            if (route != null)
            {
                expandedRouteId = id;
                if (filteredRoutes != null && filteredRoutes.Contains(route))
                {
                    int index = filteredRoutes.IndexOf(route);
                    currentPage = (index / pageSize) + 1;
                }
                StateHasChanged();
            }
        }
    }

    [JSInvokable]
    public async Task RefreshRouteDetails()
    {
        if (selectedRoute != null)
        {
            try
            {
                var refreshedRoute = await RouteService.GetRouteByIdAsync(selectedRoute.Id);
                selectedRoute = refreshedRoute;

                if (refreshedRoute.Steps != null && refreshedRoute.Steps.Any())
                {
                    toastService.ShowSuccess("Rota adımları başarıyla yüklendi");
                    await InitializeDetailMap();
                }
                else
                {
                    toastService.ShowWarning("Rota adımları hala yüklenemedi");
                }

                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Error refreshing route details: {ex.Message}");
                toastService.ShowError("Rota yenilenirken hata oluştu: " + ex.Message);
            }
        }
    }
}